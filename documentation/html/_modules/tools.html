

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>tools &mdash; Flow-Conditioned Parameter Grid Tools 1.0.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/basic.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Flow-Conditioned Parameter Grid Tools
          

          
          </a>

          
            
            
              <div class="version">
                1.0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../cookbook.html">Cookbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../functions.html">Function Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../z_references.html">References</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Flow-Conditioned Parameter Grid Tools</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Module code</a> &raquo;</li>
        
      <li>tools</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for tools</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">rasterio</span> <span class="k">as</span> <span class="nn">rs</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">urllib.request</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="k">import</span> <span class="n">Pool</span> <span class="k">as</span> <span class="n">processPool</span>

<span class="c1"># Imports for reading and writing json files</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">io</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">to_unicode</span> <span class="o">=</span> <span class="n">unicode</span>
<span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
    <span class="n">to_unicode</span> <span class="o">=</span> <span class="nb">str</span>

<span class="c1"># Imports for cascade tools</span>
<span class="kn">from</span> <span class="nn">rasterio.mask</span> <span class="k">import</span> <span class="n">mask</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>

<div class="viewcode-block" id="parsebool"><a class="viewcode-back" href="../functions.html#tools.parsebool">[docs]</a><span class="k">def</span> <span class="nf">parsebool</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Parse a boolean argument from the command line.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    b : str</span>
<span class="sd">        String of either True or False.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    res : bool</span>
<span class="sd">        True if b is &quot;True&quot; or False if b is not &quot;True.&quot;</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">return</span> <span class="n">b</span> <span class="o">==</span> <span class="s2">&quot;True&quot;</span></div>

<div class="viewcode-block" id="tauDrainDir"><a class="viewcode-back" href="../functions.html#tools.tauDrainDir">[docs]</a><span class="k">def</span> <span class="nf">tauDrainDir</span><span class="p">(</span><span class="n">inRast</span><span class="p">,</span> <span class="n">outRast</span><span class="p">,</span> <span class="n">updateDict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;compress&#39;</span><span class="p">:</span><span class="s1">&#39;LZW&#39;</span><span class="p">,</span>
            <span class="s1">&#39;sparse&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;tiled&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;blockysize&#39;</span><span class="p">:</span><span class="mi">256</span><span class="p">,</span>
            <span class="s1">&#39;blockxsize&#39;</span><span class="p">:</span><span class="mi">256</span><span class="p">,</span>
            <span class="s1">&#39;driver&#39;</span> <span class="p">:</span> <span class="s2">&quot;GTiff&quot;</span><span class="p">,</span>
            <span class="s1">&#39;nodata&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">}):</span>
    <span class="sd">&quot;&quot;&quot;Reclassifies ESRI flow directions into TauDEM flow directions.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    inRast : str</span>
<span class="sd">        Path to a raster encoded with ESRI flow direction values.</span>
<span class="sd">    outRast : str</span>
<span class="sd">        Path to output a raster with flow directions encoded for TauDEM. File will be overwritten if it already exists. </span>
<span class="sd">    updateDict : dict (optional)</span>
<span class="sd">        Dictionary of Rasterio raster options used to create outRast. Defaults have been supplied, but may not work in all situations and input file formats.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    outRast : raster</span>
<span class="sd">        Reclassified flow direction raster at the path specified above.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">inRast</span><span class="p">)</span><span class="o">==</span><span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;inRast not found&#39;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Reclassifying Flow Directions...&#39;</span><span class="p">)</span>

    <span class="c1"># load input data</span>
    <span class="k">with</span> <span class="n">rs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">inRast</span><span class="p">)</span> <span class="k">as</span> <span class="n">ds</span><span class="p">:</span>
        <span class="n">dat</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">inNoData</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">nodata</span>
        <span class="n">profile</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1"># save the metadata for output later</span>

    <span class="n">tauDir</span> <span class="o">=</span> <span class="n">dat</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="c1"># remap NHDplus flow direction to TauDEM flow Direction</span>
    <span class="c1"># east is ok</span>
    
    <span class="n">tauDir</span><span class="p">[</span><span class="n">dat</span> <span class="o">==</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span> <span class="c1"># southeast</span>
    <span class="n">tauDir</span><span class="p">[</span><span class="n">dat</span> <span class="o">==</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">7</span> <span class="c1"># south</span>
    <span class="n">tauDir</span><span class="p">[</span><span class="n">dat</span> <span class="o">==</span> <span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span> <span class="c1"># southwest</span>
    <span class="n">tauDir</span><span class="p">[</span><span class="n">dat</span> <span class="o">==</span> <span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span> <span class="c1"># west</span>
    <span class="n">tauDir</span><span class="p">[</span><span class="n">dat</span> <span class="o">==</span> <span class="mi">32</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span> <span class="c1"># northwest</span>
    <span class="n">tauDir</span><span class="p">[</span><span class="n">dat</span> <span class="o">==</span> <span class="mi">64</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span> <span class="c1"># north</span>
    <span class="n">tauDir</span><span class="p">[</span><span class="n">dat</span> <span class="o">==</span> <span class="mi">128</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="c1"># northeast</span>
    <span class="n">tauDir</span><span class="p">[</span><span class="n">dat</span> <span class="o">==</span> <span class="n">inNoData</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># no data</span>
    <span class="n">tauDir</span> <span class="o">=</span> <span class="n">tauDir</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;uint8&#39;</span><span class="p">)</span><span class="c1">#8 bit integer is sufficient for flow directions</span>

    <span class="c1"># edit the metadata</span>
    <span class="n">profile</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">updateDict</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">outRast</span><span class="p">):</span>
    	<span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">outRast</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">rs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">outRast</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">,</span><span class="o">**</span><span class="n">profile</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
        <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">tauDir</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;TauDEM drainage direction written to: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">outRast</span><span class="p">))</span></div>

<div class="viewcode-block" id="accumulateParam"><a class="viewcode-back" href="../functions.html#tools.accumulateParam">[docs]</a><span class="k">def</span> <span class="nf">accumulateParam</span><span class="p">(</span><span class="n">paramRast</span><span class="p">,</span> <span class="n">fdr</span><span class="p">,</span> <span class="n">accumRast</span><span class="p">,</span> <span class="n">outNoDataRast</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">outNoDataAccum</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">zeroNoDataRast</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">cores</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mpiCall</span> <span class="o">=</span> <span class="s1">&#39;mpiexec&#39;</span><span class="p">,</span> <span class="n">mpiArg</span> <span class="o">=</span> <span class="s1">&#39;-n&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Accumulate a parameter grid using TauDEM AreaD8 :cite:`TauDEM`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    paramRast : str </span>
<span class="sd">        Raster of parameter values to accumulate; this file is modified by the function.</span>
<span class="sd">    fdr : str</span>
<span class="sd">        Flow direction raster in TauDEM format.</span>
<span class="sd">    accumRast : str</span>
<span class="sd">        File location to store accumulated parameter values.</span>
<span class="sd">    outNoDataRast : str (optional)</span>
<span class="sd">        File location to store parameter no data raster.</span>
<span class="sd">    outNoDataAccum : str (optional)</span>
<span class="sd">        File location to store accumulated no data raster.</span>
<span class="sd">    zeroNoDataRast : str (optional)</span>
<span class="sd">        File location to store the no data raster filled with zeros.</span>
<span class="sd">    cores : int (optional)</span>
<span class="sd">        The number of cores to use for parameter accumulation. Defaults to 1.</span>
<span class="sd">    mpiCall : str (optional)</span>
<span class="sd">        The command to use for mpi, defaults to mpiexec.</span>
<span class="sd">    mpiArg : str (optional)</span>
<span class="sd">        Argument flag passed to mpiCall, which is followed by the cores parameter.</span>


<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    accumRast : raster</span>
<span class="sd">        Raster of accumulated parameter values.</span>
<span class="sd">    outNoDataRast : raster</span>
<span class="sd">        Raster of no data values.</span>
<span class="sd">    outNoDataRast : raster</span>
<span class="sd">        Raster of accumulated no data values.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">	If outNoDataRast, outNoDataAccum, and zeroNoDataRast inputs are all supplied it will set any “no data” values in the basin to zero and save that raster as zeroNoDataRast. It will then save a raster with all no data values set to one and other values set to zero (outNoDataRast) and use tauDEM to accumulate it (outNoDataAccum). It will then accumulate the parameter from the zeroNoDataRast, and a subsequent correction will be needed in the make_fcpg() function based on the values in the outNoDataAccum raster. </span>

<span class="sd">	If some of the output file locations for handling no data values aren’t supplied or “no data” values aren’t present in the parameter grid, it will simply accumulate the parameter grid. If “no data” values are present, this will result in them being propagated downstream. </span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">paramRast</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error - Parameter raster file is missing!&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="c1">#Function will fail, so end it now</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fdr</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error - Flow direction file is missing!&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="c1">#Function will fail, so end it now</span>

    <span class="k">with</span> <span class="n">rs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">paramRast</span><span class="p">)</span> <span class="k">as</span> <span class="n">ds</span><span class="p">:</span> <span class="c1"># load parameter raster</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">profile</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">profile</span>
        <span class="n">paramNoData</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">nodata</span>

    <span class="k">with</span> <span class="n">rs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fdr</span><span class="p">)</span> <span class="k">as</span> <span class="n">ds</span><span class="p">:</span> <span class="c1"># load flow direction raster</span>
        <span class="n">direction</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">directionNoData</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">nodata</span> <span class="c1"># pull the accumulated area no data value</span>

    <span class="k">if</span> <span class="n">paramNoData</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: Parameter raster no data value not specified, results may be invalid&quot;</span><span class="p">)</span>


    <span class="c1">#Deal with no data values</span>
    <span class="n">basinNoDataCount</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[(</span><span class="n">data</span> <span class="o">==</span> <span class="n">paramNoData</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">direction</span> <span class="o">!=</span> <span class="n">directionNoData</span><span class="p">)])</span> <span class="c1"># Count number of cells with flow direction but no parameter value</span>
    
    <span class="k">if</span> <span class="n">basinNoDataCount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: No data parameter values exist in basin&#39;</span><span class="p">)</span>


        <span class="c1">#If a no data file path is given, accumulate no data values</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">outNoDataRast</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">outNoDataAccum</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">zeroNoDataRast</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>

            <span class="c1">#Set no data parameter values in the basin to zero so tauDEM accumulates them</span>
            <span class="n">noDataZero</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">noDataZero</span><span class="p">[(</span><span class="n">data</span> <span class="o">==</span> <span class="n">paramNoData</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">direction</span> <span class="o">!=</span> <span class="n">directionNoData</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1">#Set no data values in basin to 0</span>

            <span class="c1"># Update profile for no data raster</span>
            <span class="n">newProfile</span> <span class="o">=</span> <span class="n">profile</span> 
            <span class="n">newProfile</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                <span class="s1">&#39;compress&#39;</span><span class="p">:</span><span class="s1">&#39;LZW&#39;</span><span class="p">,</span>
                <span class="s1">&#39;profile&#39;</span><span class="p">:</span><span class="s1">&#39;GeoTIFF&#39;</span><span class="p">,</span>
                <span class="s1">&#39;tiled&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;sparse_ok&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;num_threads&#39;</span><span class="p">:</span><span class="s1">&#39;ALL_CPUS&#39;</span><span class="p">,</span>
                <span class="s1">&#39;bigtiff&#39;</span><span class="p">:</span><span class="s1">&#39;IF_SAFER&#39;</span><span class="p">})</span>
            
            <span class="c1"># Save no data raster</span>
            <span class="k">with</span> <span class="n">rs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">zeroNoDataRast</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">newProfile</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
                <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">noDataZero</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Parameter Zero No Data raster written to: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zeroNoDataRast</span><span class="p">))</span>


            
            <span class="n">noDataArray</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">noDataArray</span><span class="p">[(</span><span class="n">data</span> <span class="o">==</span> <span class="n">paramNoData</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">direction</span> <span class="o">!=</span> <span class="n">directionNoData</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1">#Set no data values in basin to 1</span>
            <span class="n">noDataArray</span><span class="p">[(</span><span class="n">data</span> <span class="o">!=</span> <span class="n">paramNoData</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1">#Set values with data to 0</span>
            <span class="n">noDataArray</span><span class="p">[(</span><span class="n">direction</span> <span class="o">==</span> <span class="n">directionNoData</span><span class="p">)]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="c1">#Set all values outside of basin to -1</span>
            <span class="n">noDataArray</span> <span class="o">=</span> <span class="n">noDataArray</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>

            <span class="c1"># Update profile for no data raster</span>
            <span class="n">newProfile</span> <span class="o">=</span> <span class="n">profile</span> 
            <span class="n">newProfile</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                    <span class="s1">&#39;dtype&#39;</span><span class="p">:</span><span class="s1">&#39;int8&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;compress&#39;</span><span class="p">:</span><span class="s1">&#39;LZW&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;profile&#39;</span><span class="p">:</span><span class="s1">&#39;GeoTIFF&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;tiled&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span>
                    <span class="s1">&#39;sparse_ok&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span>
                    <span class="s1">&#39;num_threads&#39;</span><span class="p">:</span><span class="s1">&#39;ALL_CPUS&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;nodata&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="s1">&#39;bigtiff&#39;</span><span class="p">:</span><span class="s1">&#39;IF_SAFER&#39;</span><span class="p">})</span>
            
            <span class="c1"># Save no data raster</span>
            <span class="k">with</span> <span class="n">rs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">outNoDataRast</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">newProfile</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
                <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">noDataArray</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Parameter No Data raster written to: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">outNoDataRast</span><span class="p">))</span>


            <span class="c1"># Use tauDEM to accumulate no data values</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Accumulating No Data Values&#39;</span><span class="p">)</span>
                
                    
                <span class="n">tauParams</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;fdr&#39;</span><span class="p">:</span><span class="n">fdr</span><span class="p">,</span>
                <span class="s1">&#39;cores&#39;</span><span class="p">:</span><span class="n">cores</span><span class="p">,</span> 
                <span class="s1">&#39;outFl&#39;</span><span class="p">:</span><span class="n">outNoDataAccum</span><span class="p">,</span>
                <span class="s1">&#39;weight&#39;</span><span class="p">:</span><span class="n">outNoDataRast</span><span class="p">,</span>
                <span class="s1">&#39;mpiCall&#39;</span><span class="p">:</span><span class="n">mpiCall</span><span class="p">,</span>
                <span class="s1">&#39;mpiArg&#39;</span><span class="p">:</span><span class="n">mpiArg</span>
                <span class="p">}</span>
                
                <span class="n">cmd</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{mpiCall}</span><span class="s1"> </span><span class="si">{mpiArg}</span><span class="s1"> </span><span class="si">{cores}</span><span class="s1"> aread8 -p </span><span class="si">{fdr}</span><span class="s1"> -ad8 </span><span class="si">{outFl}</span><span class="s1"> -wg </span><span class="si">{weight}</span><span class="s1"> -nc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">tauParams</span><span class="p">)</span> <span class="c1"># Create string of tauDEM shell command</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="c1"># Run shell command</span>
                <span class="n">result</span><span class="o">.</span><span class="n">stdout</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Parameter no data accumulation written to: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">outNoDataRast</span><span class="p">))</span>
                
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error Accumulating Data&#39;</span><span class="p">)</span>
                <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>

            <span class="n">tauDEMweight</span> <span class="o">=</span> <span class="n">zeroNoDataRast</span> <span class="c1">#Set file to use as weight in tauDEM accumulation</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#If some of the no data handling files aren&#39;t provided, accumulate the parameter with no data values included</span>
            <span class="c1">#This will result in no data values being propagated downstream</span>
            <span class="n">tauDEMweight</span> <span class="o">=</span> <span class="n">paramRast</span> <span class="c1">#Set file to use as weight in tauDEM accumulation</span>
        

            
    <span class="k">else</span><span class="p">:</span>

        <span class="c1">#If there are zero no data values in the basin, simply accumulate the parameter raster</span>
        <span class="n">tauDEMweight</span> <span class="o">=</span> <span class="n">paramRast</span> <span class="c1">#Set file to use as weight in tauDEM accumulation</span>

            

    <span class="c1">#Use tauDEM to accumulate the parameter</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Accumulating Data...&#39;</span><span class="p">)</span>
        <span class="n">tauParams</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;fdr&#39;</span><span class="p">:</span><span class="n">fdr</span><span class="p">,</span>
        <span class="s1">&#39;cores&#39;</span><span class="p">:</span><span class="n">cores</span><span class="p">,</span> 
        <span class="s1">&#39;outFl&#39;</span><span class="p">:</span><span class="n">accumRast</span><span class="p">,</span> 
        <span class="s1">&#39;weight&#39;</span><span class="p">:</span><span class="n">tauDEMweight</span><span class="p">,</span>
        <span class="s1">&#39;mpiCall&#39;</span><span class="p">:</span><span class="n">mpiCall</span><span class="p">,</span>
        <span class="s1">&#39;mpiArg&#39;</span><span class="p">:</span><span class="n">mpiArg</span>
        <span class="p">}</span>
        
        <span class="n">cmd</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{mpiCall}</span><span class="s1"> </span><span class="si">{mpiArg}</span><span class="s1"> </span><span class="si">{cores}</span><span class="s1"> aread8 -p </span><span class="si">{fdr}</span><span class="s1"> -ad8 </span><span class="si">{outFl}</span><span class="s1"> -wg </span><span class="si">{weight}</span><span class="s1"> -nc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">tauParams</span><span class="p">)</span> <span class="c1"># Create string of tauDEM shell command</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="c1"># Run shell command</span>
        
        <span class="n">result</span><span class="o">.</span><span class="n">stdout</span>
        

    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error Accumulating Data&#39;</span><span class="p">)</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span></div>

    
<div class="viewcode-block" id="make_fcpg"><a class="viewcode-back" href="../functions.html#tools.make_fcpg">[docs]</a><span class="k">def</span> <span class="nf">make_fcpg</span><span class="p">(</span><span class="n">accumParam</span><span class="p">,</span> <span class="n">fac</span><span class="p">,</span> <span class="n">outRast</span><span class="p">,</span> <span class="n">noDataRast</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">minAccum</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Create a flow-conditioned parameter grid using accumulated parameter and area rasters. See also :py:func:`make_fcpgs`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    accumParam : str</span>
<span class="sd">        File location of the accumulated parameter data raster.</span>
<span class="sd">    fac : str</span>
<span class="sd">        File location of the flow accumulation raster.</span>
<span class="sd">    outRast : str</span>
<span class="sd">        File location of the output flow-conditioned parameter grid.</span>
<span class="sd">    noDataRast : str</span>
<span class="sd">        File location of the accumulated parameter no data raster.</span>
<span class="sd">    minAccum : float</span>
<span class="sd">        Value of flow accumulation below which the CPG values will be set to no data</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    outRast : raster</span>
<span class="sd">        Flow-conditioned parameter grid file where grid cell values represent the mean upstream value of the paramter. </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">outNoData</span> <span class="o">=</span> <span class="o">-</span><span class="mi">9999</span>
    

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">accumParam</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error - Accumulated parameter raster file is missing!&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="c1">#Function will fail, so end it now</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fac</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error - Flow accumulation file is missing!&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="c1">#Function will fail, so end it now</span>


    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reading accumulated parameter file </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()))</span>
    <span class="k">with</span> <span class="n">rs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">accumParam</span><span class="p">)</span> <span class="k">as</span> <span class="n">ds</span><span class="p">:</span> <span class="c1"># load accumulated data and no data rasters</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">profile</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">profile</span>
        <span class="n">inNoData</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">nodata</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="c1">#Convert to 32 bit float</span>
    <span class="n">data</span><span class="p">[</span><span class="n">data</span> <span class="o">==</span> <span class="n">inNoData</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span> <span class="c1"># fill with no data values where appropriate</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reading basin flow accumulation file </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()))</span>
    <span class="k">with</span> <span class="n">rs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fac</span><span class="p">)</span> <span class="k">as</span> <span class="n">ds</span><span class="p">:</span> <span class="c1"># flow accumulation raster</span>
        <span class="n">accum</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">facNoData</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">nodata</span> <span class="c1"># pull the accumulated area no data value</span>


    <span class="k">if</span> <span class="n">noDataRast</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Correcting CPG for no data values&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">rs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">noDataRast</span><span class="p">)</span> <span class="k">as</span> <span class="n">ds</span><span class="p">:</span> <span class="c1"># accumulated no data raster</span>
            <span class="n">accumNoData</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">noDataNoData</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">nodata</span> <span class="c1"># pull the accumulated no data no data value</span>
            
        <span class="n">accumNoData</span><span class="p">[</span><span class="n">accumNoData</span> <span class="o">==</span> <span class="n">noDataNoData</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1">#Set no data values to zero</span>

        <span class="n">corrAccum</span> <span class="o">=</span> <span class="n">accum</span> <span class="o">-</span> <span class="n">accumNoData</span> <span class="c1"># Compute corrected accumulation</span>
        <span class="n">corrAccum</span> <span class="o">=</span> <span class="n">corrAccum</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="c1"># Convert to 32 bit float</span>
        <span class="n">corrAccum</span><span class="p">[</span><span class="n">accum</span> <span class="o">==</span> <span class="n">facNoData</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span> <span class="c1"># fill with no data values where appropriate</span>
        
    <span class="k">else</span><span class="p">:</span>
        <span class="n">accum2</span> <span class="o">=</span> <span class="n">accum</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">accum2</span><span class="p">[</span><span class="n">accum</span> <span class="o">==</span> <span class="n">facNoData</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span> <span class="c1"># fill this with no data values where appropriate</span>
        <span class="n">corrAccum</span> <span class="o">=</span> <span class="n">accum2</span> <span class="c1"># No correction required</span>
        
    <span class="c1"># Throw warning if there is a negative accumulation</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">corrAccum</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: Negative accumulation value&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Minimum value:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">corrAccum</span><span class="p">)))</span>
 
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Computing CPG values </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()))</span>
    <span class="n">dataCPG</span> <span class="o">=</span> <span class="n">data</span> <span class="o">/</span> <span class="p">(</span><span class="n">corrAccum</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># make data CPG</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Replacing numpy nan values </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()))</span>
    <span class="n">dataCPG</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">dataCPG</span><span class="p">)]</span> <span class="o">=</span> <span class="n">outNoData</span> <span class="c1"># Replace numpy NaNs with no data value</span>

    <span class="c1"># Replace values in cells with small flow accumulation with no data</span>
    <span class="k">if</span> <span class="n">minAccum</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Replacing small flow accumulations </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()))</span>
        <span class="n">dataCPG</span><span class="p">[</span><span class="n">corrAccum</span> <span class="o">&lt;</span> <span class="n">minAccum</span><span class="p">]</span> <span class="o">=</span> <span class="n">outNoData</span> <span class="c1">#Set values smaller than threshold to no data</span>

    <span class="c1"># Update raster profile</span>
    <span class="n">profile</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;dtype&#39;</span><span class="p">:</span><span class="n">dataCPG</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                <span class="s1">&#39;compress&#39;</span><span class="p">:</span><span class="s1">&#39;LZW&#39;</span><span class="p">,</span>
                <span class="s1">&#39;profile&#39;</span><span class="p">:</span><span class="s1">&#39;GeoTIFF&#39;</span><span class="p">,</span>
                <span class="s1">&#39;tiled&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;sparse_ok&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;num_threads&#39;</span><span class="p">:</span><span class="s1">&#39;ALL_CPUS&#39;</span><span class="p">,</span>
                <span class="s1">&#39;nodata&#39;</span><span class="p">:</span><span class="n">outNoData</span><span class="p">,</span>
                <span class="s1">&#39;bigtiff&#39;</span><span class="p">:</span><span class="s1">&#39;IF_SAFER&#39;</span><span class="p">})</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Saving CPG raster </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()))</span>
    <span class="k">with</span> <span class="n">rs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">outRast</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">profile</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
        <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">dataCPG</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;CPG file written to: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">outRast</span><span class="p">))</span></div>
    
<div class="viewcode-block" id="resampleParam"><a class="viewcode-back" href="../functions.html#tools.resampleParam">[docs]</a><span class="k">def</span> <span class="nf">resampleParam</span><span class="p">(</span><span class="n">inParam</span><span class="p">,</span> <span class="n">fdr</span><span class="p">,</span> <span class="n">outParam</span><span class="p">,</span> <span class="n">resampleMethod</span><span class="o">=</span><span class="s2">&quot;bilinear&quot;</span><span class="p">,</span> <span class="n">cores</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">forceProj</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">forceProj4</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">+proj=aea +lat_1=29.5 +lat_2=45.5 +lat_0=23 +lon_0=-96 +x_0=0 +y_0=0 +ellps=GRS80 +datum=NAD83 +units=m +no_defs</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Resample, re-project, and clip the parameter raster based on the resolution, projection, and extent of the of the flow direction raster supplied. See also :py:func:`resampleParams`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    inParam : str</span>
<span class="sd">        Path to the input parameter data raster</span>
<span class="sd">    fdr : str</span>
<span class="sd">        Path to the flow direction raster</span>
<span class="sd">    outParam : str</span>
<span class="sd">        Path to the output file for the resampled parameter raster.</span>
<span class="sd">    resampleMethod : str (optional)</span>
<span class="sd">        resampling method, either &#39;bilinear&#39; or &#39;nearest neighbor&#39;. Bilinear should generally be used for continuous data sets such as precipitation while nearest neighbor should generally be used for categorical datasets such as land cover type. Defaults to bilinear.</span>
<span class="sd">    cores : int (optional)</span>
<span class="sd">        The number of cores to use. Defaults to 1.</span>
<span class="sd">    forceProj : bool (optional)</span>
<span class="sd">        Force the projection of the flow direction raster. This can be useful if the flow direction raster has an unusual projection. Defaults to False.</span>
<span class="sd">    forceProj4 : str (optional)</span>
<span class="sd">        Proj4 string used to force the flow direction raster. This defaults to USGS Albers, but is not used unless the forceProj parameter is set to True. </span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    outParam : raster</span>
<span class="sd">        Resampled, reprojected, and clipped parameter raster.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">with</span> <span class="n">rs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fdr</span><span class="p">)</span> <span class="k">as</span> <span class="n">ds</span><span class="p">:</span> <span class="c1"># load flow direction raster in Rasterio</span>
        <span class="n">fdrcrs</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">crs</span> <span class="c1">#Get flow direction coordinate system</span>
        <span class="n">xsize</span><span class="p">,</span> <span class="n">ysize</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">res</span> <span class="c1">#Get flow direction cell size</span>
        <span class="c1">#Get bounding coordinates of the flow direction raster</span>
        <span class="n">fdrXmin</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">transform</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">fdrYmax</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">transform</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
        <span class="n">fdrXmax</span> <span class="o">=</span> <span class="n">fdrXmin</span> <span class="o">+</span> <span class="n">xsize</span><span class="o">*</span><span class="n">ds</span><span class="o">.</span><span class="n">width</span>
        <span class="n">fdrYmin</span> <span class="o">=</span> <span class="n">fdrYmax</span> <span class="o">-</span> <span class="n">ysize</span><span class="o">*</span><span class="n">ds</span><span class="o">.</span><span class="n">height</span>

    <span class="k">with</span> <span class="n">rs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">inParam</span><span class="p">)</span> <span class="k">as</span> <span class="n">ds</span><span class="p">:</span> <span class="c1"># load parameter raster in Rasterio</span>
        <span class="n">paramNoData</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">nodata</span>
        <span class="n">paramType</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">dtypes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1">#Get datatype of first band</span>
        <span class="n">paramcrs</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">crs</span> <span class="c1">#Get parameter coordinate reference system</span>
        <span class="n">paramXsize</span><span class="p">,</span> <span class="n">paramYsize</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">res</span> <span class="c1">#Get parameter cell size</span>

    <span class="c1"># override the FDR projection if specified.</span>
    <span class="k">if</span> <span class="n">forceProj</span><span class="p">:</span>
        <span class="n">fdrcrs</span> <span class="o">=</span> <span class="n">forceProj4</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Flow Direction Proj4: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">fdrcrs</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Parameter Proj4:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">paramcrs</span><span class="p">))</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Flow Direction Xsize:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">xsize</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Parameter Xsize:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">paramXsize</span><span class="p">))</span>
    
    <span class="c1"># Choose an appropriate gdal data type for the parameter</span>
    <span class="k">if</span> <span class="n">paramType</span> <span class="o">==</span> <span class="s1">&#39;int8&#39;</span><span class="p">:</span>
        <span class="n">outType</span> <span class="o">=</span> <span class="s1">&#39;Int16&#39;</span> <span class="c1"># Convert 8 bit integers to 16 bit in gdal</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: 8 bit inputs are unsupported and may not be reprojected correctly&quot;</span><span class="p">)</span> <span class="c1">#Print warning that gdal may cause problems with 8 bit rasters</span>
    <span class="k">elif</span> <span class="n">paramType</span> <span class="o">==</span> <span class="s1">&#39;int16&#39;</span><span class="p">:</span>
        <span class="n">outType</span> <span class="o">=</span> <span class="s1">&#39;Int16&#39;</span> 
    <span class="k">elif</span> <span class="n">paramType</span> <span class="o">==</span> <span class="s1">&#39;int32&#39;</span><span class="p">:</span>
        <span class="n">outType</span> <span class="o">=</span> <span class="s1">&#39;Int32&#39;</span>
    <span class="k">elif</span> <span class="n">paramType</span> <span class="o">==</span> <span class="s1">&#39;int64&#39;</span><span class="p">:</span>
        <span class="n">outType</span> <span class="o">=</span> <span class="s1">&#39;Int64&#39;</span>
    <span class="k">elif</span> <span class="n">paramType</span> <span class="o">==</span> <span class="s1">&#39;float32&#39;</span><span class="p">:</span>
        <span class="n">outType</span> <span class="o">=</span> <span class="s1">&#39;Float32&#39;</span>
    <span class="k">elif</span> <span class="n">paramType</span> <span class="o">==</span> <span class="s1">&#39;float64&#39;</span><span class="p">:</span>
        <span class="n">outType</span> <span class="o">=</span> <span class="s1">&#39;Float64&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: Unsupported data type </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">paramType</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Defaulting to Float64&quot;</span><span class="p">)</span>
        <span class="n">outType</span> <span class="o">=</span> <span class="s1">&#39;Float64&#39;</span> <span class="c1"># Try a 64 bit floating point if all else fails</span>

    <span class="c1">#Check if resampling or reprojection are required</span>
    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">paramcrs</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">fdrcrs</span><span class="p">)</span> <span class="ow">and</span> <span class="n">paramXsize</span> <span class="o">==</span> <span class="n">xsize</span> <span class="ow">and</span> <span class="n">paramYsize</span> <span class="o">==</span> <span class="n">ysize</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Parameter does not require reprojection or resampling&quot;</span><span class="p">)</span>
    
    <span class="k">else</span><span class="p">:</span>

        <span class="c1"># Resample, reproject, and clip the parameter raster with GDAL</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Resampling and Reprojecting Parameter Raster...&#39;</span><span class="p">)</span>
            <span class="n">warpParams</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;inParam&#39;</span><span class="p">:</span> <span class="n">inParam</span><span class="p">,</span>
            <span class="s1">&#39;outParam&#39;</span><span class="p">:</span> <span class="n">outParam</span><span class="p">,</span>
            <span class="s1">&#39;fdr&#39;</span><span class="p">:</span><span class="n">fdr</span><span class="p">,</span>
            <span class="s1">&#39;cores&#39;</span><span class="p">:</span><span class="nb">str</span><span class="p">(</span><span class="n">cores</span><span class="p">),</span> 
            <span class="s1">&#39;resampleMethod&#39;</span><span class="p">:</span> <span class="n">resampleMethod</span><span class="p">,</span>
            <span class="s1">&#39;xsize&#39;</span><span class="p">:</span> <span class="n">xsize</span><span class="p">,</span> 
            <span class="s1">&#39;ysize&#39;</span><span class="p">:</span> <span class="n">ysize</span><span class="p">,</span> 
            <span class="s1">&#39;fdrXmin&#39;</span><span class="p">:</span> <span class="n">fdrXmin</span><span class="p">,</span>
            <span class="s1">&#39;fdrXmax&#39;</span><span class="p">:</span> <span class="n">fdrXmax</span><span class="p">,</span>
            <span class="s1">&#39;fdrYmin&#39;</span><span class="p">:</span> <span class="n">fdrYmin</span><span class="p">,</span>
            <span class="s1">&#39;fdrYmax&#39;</span><span class="p">:</span> <span class="n">fdrYmax</span><span class="p">,</span>
            <span class="s1">&#39;fdrcrs&#39;</span><span class="p">:</span> <span class="n">fdrcrs</span><span class="p">,</span> 
            <span class="s1">&#39;nodata&#39;</span><span class="p">:</span> <span class="n">paramNoData</span><span class="p">,</span>
            <span class="s1">&#39;datatype&#39;</span><span class="p">:</span> <span class="n">outType</span>
            <span class="p">}</span>
            
            <span class="n">cmd</span> <span class="o">=</span> <span class="s1">&#39;gdalwarp -overwrite -tr </span><span class="si">{xsize}</span><span class="s1"> </span><span class="si">{ysize}</span><span class="s1"> -t_srs </span><span class="si">{fdrcrs}</span><span class="s1"> -te </span><span class="si">{fdrXmin}</span><span class="s1"> </span><span class="si">{fdrYmin}</span><span class="s1"> </span><span class="si">{fdrXmax}</span><span class="s1"> </span><span class="si">{fdrYmax}</span><span class="s1"> -co &quot;PROFILE=GeoTIFF&quot; -co &quot;TILED=YES&quot; -co &quot;SPARSE_OK=TRUE&quot; -co &quot;COMPRESS=LZW&quot; -co &quot;NUM_THREADS=</span><span class="si">{cores}</span><span class="s1">&quot; -co &quot;BIGTIFF=IF_SAFER&quot; -r </span><span class="si">{resampleMethod}</span><span class="s1"> -dstnodata </span><span class="si">{nodata}</span><span class="s1"> -ot </span><span class="si">{datatype}</span><span class="s1"> </span><span class="si">{inParam}</span><span class="s1"> </span><span class="si">{outParam}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">warpParams</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">stdout</span>
            
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error Reprojecting Parameter Raster&#39;</span><span class="p">)</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span></div>

<span class="c1">#Tools for decayed accumulation CPGs</span>

<div class="viewcode-block" id="makeDecayGrid"><a class="viewcode-back" href="../functions.html#tools.makeDecayGrid">[docs]</a><span class="k">def</span> <span class="nf">makeDecayGrid</span><span class="p">(</span><span class="n">d2strm</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">outRast</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Create a decay raster where grid cell values are computed as the inverse number of grid cells, :math:`\\frac{dx}{n+k*dx}`, where n is the distance from the d2strm raster and    from each grid cell to the nearest stream, k is the constant applied to the stream distance values, and dx is the cell size of the raster.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    d2strm : str</span>
<span class="sd">        Path to raster of flow distances from each grid cell to the nearest stream.</span>
<span class="sd">    k : float</span>
<span class="sd">        Constant applied to decay factor denominator; this has units equal to the horizontal map units in the d2strm raster.</span>
<span class="sd">    outRast : str</span>
<span class="sd">        Output file path for decay grid.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        outRast : raster</span>
<span class="sd">            Raster file with grid cells values representing weights decaying as a function of the distance to stream.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">d2strm</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error - Stream distance raster file is missing!&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="c1">#Function will fail, so end it now</span>


    <span class="k">with</span> <span class="n">rs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">d2strm</span><span class="p">)</span> <span class="k">as</span> <span class="n">ds</span><span class="p">:</span> <span class="c1"># load flow direction data</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">profile</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">profile</span>
        <span class="n">inNoData</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">nodata</span>
        <span class="n">xsize</span><span class="p">,</span> <span class="n">ysize</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">res</span> <span class="c1">#Get flow direction cell size</span>
    
    <span class="k">if</span> <span class="n">xsize</span> <span class="o">!=</span> <span class="n">ysize</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning - grid cells are not square, results may be incorrect&quot;</span><span class="p">)</span>


    <span class="n">outNoData</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1">#Set no data value for output raster</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Building decay grid </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()))</span>
    <span class="n">decayGrid</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="c1">#Convert to float</span>
    <span class="n">decayGrid</span><span class="p">[</span><span class="n">data</span> <span class="o">==</span> <span class="n">inNoData</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span> <span class="c1"># fill with no data values where appropriate</span>
    <span class="n">decayGrid</span> <span class="o">=</span> <span class="n">xsize</span><span class="o">/</span><span class="p">(</span><span class="n">decayGrid</span> <span class="o">+</span> <span class="n">k</span><span class="o">*</span><span class="n">xsize</span><span class="p">)</span> <span class="c1">#Compute decay function</span>

    <span class="n">decayGrid</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">decayGrid</span><span class="p">)]</span> <span class="o">=</span> <span class="n">outNoData</span> <span class="c1"># Replace numpy NaNs with no data value</span>

    <span class="c1"># Update raster profile</span>
    <span class="n">profile</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                <span class="s1">&#39;dtype&#39;</span><span class="p">:</span> <span class="n">decayGrid</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                <span class="s1">&#39;compress&#39;</span><span class="p">:</span><span class="s1">&#39;LZW&#39;</span><span class="p">,</span>
                <span class="s1">&#39;profile&#39;</span><span class="p">:</span><span class="s1">&#39;GeoTIFF&#39;</span><span class="p">,</span>
                <span class="s1">&#39;tiled&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;sparse_ok&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;num_threads&#39;</span><span class="p">:</span><span class="s1">&#39;ALL_CPUS&#39;</span><span class="p">,</span>
                <span class="s1">&#39;nodata&#39;</span><span class="p">:</span><span class="n">inNoData</span><span class="p">,</span>
                <span class="s1">&#39;bigtiff&#39;</span><span class="p">:</span><span class="s1">&#39;IF_SAFER&#39;</span><span class="p">})</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Saving decay raster </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()))</span>
    
    <span class="k">with</span> <span class="n">rs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">outRast</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">profile</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
        <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">decayGrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Decay raster written to: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">outRast</span><span class="p">))</span></div>

<div class="viewcode-block" id="applyMult"><a class="viewcode-back" href="../functions.html#tools.applyMult">[docs]</a><span class="k">def</span> <span class="nf">applyMult</span><span class="p">(</span><span class="n">inRast</span><span class="p">,</span> <span class="n">mult</span><span class="p">,</span> <span class="n">outRast</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Multiply input raster by mult.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    inRast : str</span>
<span class="sd">        Path to input raster.</span>
<span class="sd">    mult : str</span>
<span class="sd">        Path to multiplier raster.</span>
<span class="sd">    outRast : str</span>
<span class="sd">        Path to output raster.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    outRast : raster</span>
<span class="sd">        Input raster multiplied by the multiplier raster.</span>
<span class="sd">    &#39;&#39;&#39;</span>  

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">inRast</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error - Input parameter raster file is missing!&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="c1">#Function will fail, so end it now</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">mult</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error - Multiplier file is missing!&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="c1">#Function will fail, so end it now</span>


    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reading input rasters </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()))</span>
    <span class="k">with</span> <span class="n">rs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">inRast</span><span class="p">)</span> <span class="k">as</span> <span class="n">ds</span><span class="p">:</span> <span class="c1"># load input rasters</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">profile</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">profile</span>
        <span class="n">inNoData</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">nodata</span>
    
    <span class="k">with</span> <span class="n">rs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">mult</span><span class="p">)</span> <span class="k">as</span> <span class="n">ds</span><span class="p">:</span> <span class="c1"># load input rasters</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">mNoData</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">nodata</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="c1">#Convert to 32 bit float</span>
    <span class="n">data</span><span class="p">[</span><span class="n">data</span> <span class="o">==</span> <span class="n">inNoData</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span> <span class="c1"># fill with no data values where appropriate</span>
    <span class="n">m</span><span class="p">[</span><span class="n">m</span> <span class="o">==</span> <span class="n">mNoData</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span> <span class="c1"># fill with no data values where appropriate</span>
    <span class="n">outData</span> <span class="o">=</span> <span class="n">data</span> <span class="o">*</span> <span class="n">multiplier</span> <span class="c1">#Multiply the parameter values by the multiplier</span>

    <span class="n">outNoData</span> <span class="o">=</span> <span class="o">-</span><span class="mi">9999</span>
    <span class="n">outData</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">outData</span><span class="p">)]</span> <span class="o">=</span> <span class="n">outNoData</span> <span class="c1"># Replace numpy NaNs with no data value</span>

    <span class="c1"># Update raster profile</span>
    <span class="n">profile</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;dtype&#39;</span><span class="p">:</span><span class="n">outData</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                <span class="s1">&#39;compress&#39;</span><span class="p">:</span><span class="s1">&#39;LZW&#39;</span><span class="p">,</span>
                <span class="s1">&#39;profile&#39;</span><span class="p">:</span><span class="s1">&#39;GeoTIFF&#39;</span><span class="p">,</span>
                <span class="s1">&#39;tiled&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;sparse_ok&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;num_threads&#39;</span><span class="p">:</span><span class="s1">&#39;ALL_CPUS&#39;</span><span class="p">,</span>
                <span class="s1">&#39;nodata&#39;</span><span class="p">:</span><span class="n">outNoData</span><span class="p">,</span>
                <span class="s1">&#39;bigtiff&#39;</span><span class="p">:</span><span class="s1">&#39;IF_SAFER&#39;</span><span class="p">})</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Saving raster </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()))</span>
    <span class="k">with</span> <span class="n">rs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">outRast</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">profile</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
        <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">outData</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Raster written to: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">outRast</span><span class="p">))</span></div>


<div class="viewcode-block" id="decayAccum"><a class="viewcode-back" href="../functions.html#tools.decayAccum">[docs]</a><span class="k">def</span> <span class="nf">decayAccum</span><span class="p">(</span><span class="n">ang</span><span class="p">,</span> <span class="n">mult</span><span class="p">,</span> <span class="n">outRast</span><span class="p">,</span> <span class="n">paramRast</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">cores</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">mpiCall</span> <span class="o">=</span> <span class="s1">&#39;mpiexec&#39;</span><span class="p">,</span> <span class="n">mpiArg</span> <span class="o">=</span> <span class="s1">&#39;-n&#39;</span><span class="p">)</span> <span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;Decay the accumulation of a parameter raster.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ang : str</span>
<span class="sd">        Path to flow angle raster from the TauDEM D-Infinity flow direction tool.</span>
<span class="sd">    mult : str</span>
<span class="sd">        Path to raster of multiplier values applied to upstream accumulations, 1 corresponds to no decay, 0 corresponds to complete decay.</span>
<span class="sd">    outRast : str</span>
<span class="sd">        Path to output raster for decayed accumulation raster.</span>
<span class="sd">    paramRast : str (optional)</span>
<span class="sd">        Raster of parameter values to accumulate. If not supplied area will be accumulated. Defaults to None.</span>
<span class="sd">    cores : int (optional)</span>
<span class="sd">        Number of cores to use. Defaults to 1.</span>
<span class="sd">    mpiCall : str (optional)</span>
<span class="sd">        The command to use for mpi, defaults to mpiexec.</span>
<span class="sd">    mpiArg : str (optional)</span>
<span class="sd">        Argument flag passed to mpiCall, which is followed by the cores parameter.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    outRast : raster</span>
<span class="sd">        Decayed accumulation raster, either area or parameter depending on what is supplied to the function.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">paramRast</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Accumulating parameter&#39;</span><span class="p">)</span>
            <span class="n">tauParams</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;ang&#39;</span><span class="p">:</span><span class="n">ang</span><span class="p">,</span>
            <span class="s1">&#39;cores&#39;</span><span class="p">:</span><span class="n">cores</span><span class="p">,</span> 
            <span class="s1">&#39;dm&#39;</span><span class="p">:</span><span class="n">mult</span><span class="p">,</span>
            <span class="s1">&#39;dsca&#39;</span><span class="p">:</span> <span class="n">outRast</span><span class="p">,</span>
            <span class="s1">&#39;weight&#39;</span><span class="p">:</span><span class="n">paramRast</span><span class="p">,</span>
            <span class="s1">&#39;mpiCall&#39;</span><span class="p">:</span><span class="n">mpiCall</span><span class="p">,</span>
            <span class="s1">&#39;mpiArg&#39;</span><span class="p">:</span><span class="n">mpiArg</span>
            <span class="p">}</span>
                    
            <span class="n">cmd</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{mpiCall}</span><span class="s1"> </span><span class="si">{mpiArg}</span><span class="s1"> </span><span class="si">{cores}</span><span class="s1"> dinfdecayaccum -ang </span><span class="si">{ang}</span><span class="s1"> -dm </span><span class="si">{dm}</span><span class="s1"> -dsca </span><span class="si">{dsca}</span><span class="s1">, -wg </span><span class="si">{weight}</span><span class="s1"> -nc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">tauParams</span><span class="p">)</span> <span class="c1"># Create string of tauDEM shell command</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="c1"># Run shell command</span>
            <span class="n">result</span><span class="o">.</span><span class="n">stdout</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Parameter accumulation written to: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">outRast</span><span class="p">))</span>
                    
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error Accumulating Data&#39;</span><span class="p">)</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Accumulating parameter&#39;</span><span class="p">)</span>
            <span class="n">tauParams</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;ang&#39;</span><span class="p">:</span><span class="n">ang</span><span class="p">,</span>
            <span class="s1">&#39;cores&#39;</span><span class="p">:</span><span class="n">cores</span><span class="p">,</span> 
            <span class="s1">&#39;dm&#39;</span><span class="p">:</span><span class="n">mult</span><span class="p">,</span>
            <span class="s1">&#39;dsca&#39;</span><span class="p">:</span> <span class="n">outRast</span><span class="p">,</span>
            <span class="s1">&#39;mpiCall&#39;</span><span class="p">:</span><span class="n">mpiCall</span><span class="p">,</span>
            <span class="s1">&#39;mpiArg&#39;</span><span class="p">:</span><span class="n">mpiArg</span>
            <span class="p">}</span>
                    
            <span class="n">cmd</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{mpiCall}</span><span class="s1"> </span><span class="si">{mpiArg}</span><span class="s1"> </span><span class="si">{cores}</span><span class="s1"> dinfdecayaccum -ang </span><span class="si">{ang}</span><span class="s1"> -dm </span><span class="si">{dm}</span><span class="s1"> -dsca </span><span class="si">{dsca}</span><span class="s1">, -nc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">tauParams</span><span class="p">)</span> <span class="c1"># Create string of tauDEM shell command</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="c1"># Run shell command</span>
            <span class="n">result</span><span class="o">.</span><span class="n">stdout</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Parameter accumulation written to: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">outRast</span><span class="p">))</span>
                
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error Accumulating Data&#39;</span><span class="p">)</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span></div>



<div class="viewcode-block" id="dist2stream"><a class="viewcode-back" href="../functions.html#tools.dist2stream">[docs]</a><span class="k">def</span> <span class="nf">dist2stream</span><span class="p">(</span><span class="n">fdr</span><span class="p">,</span> <span class="n">fac</span><span class="p">,</span> <span class="n">thresh</span><span class="p">,</span> <span class="n">outRast</span><span class="p">,</span> <span class="n">cores</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">mpiCall</span> <span class="o">=</span> <span class="s1">&#39;mpiexec&#39;</span><span class="p">,</span> <span class="n">mpiArg</span> <span class="o">=</span> <span class="s1">&#39;-n&#39;</span><span class="p">)</span> <span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;Compute distance to streams.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fdr : str</span>
<span class="sd">        Path to flow direction raster in TauDEM format.</span>
<span class="sd">    fac : str</span>
<span class="sd">        Path to flow accumulation raster.</span>
<span class="sd">    thresh : int</span>
<span class="sd">        Accumulation threshold for stream formation in number of grid cells.</span>
<span class="sd">    outRast : str</span>
<span class="sd">        Path to output the distance raster.</span>
<span class="sd">    cores : int (optional)</span>
<span class="sd">        The number of cores to use. Defaults to 1.</span>
<span class="sd">    mpiCall : str (optional)</span>
<span class="sd">        The command to use for mpi, defaults to mpiexec.</span>
<span class="sd">    mpiArg : str (optional)</span>
<span class="sd">        Argument flag passed to mpiCall, which is followed by the cores parameter.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    outRast : raster </span>
<span class="sd">        Raster with values of D-8 flow distance from each cell to the nearest stream.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">tauParams</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;fdr&#39;</span><span class="p">:</span><span class="n">fdr</span><span class="p">,</span>
        <span class="s1">&#39;cores&#39;</span><span class="p">:</span><span class="n">cores</span><span class="p">,</span> 
        <span class="s1">&#39;fac&#39;</span><span class="p">:</span><span class="n">fac</span><span class="p">,</span>
        <span class="s1">&#39;outRast&#39;</span><span class="p">:</span> <span class="n">outRast</span><span class="p">,</span>
        <span class="s1">&#39;thresh&#39;</span><span class="p">:</span><span class="n">thresh</span><span class="p">,</span>
        <span class="s1">&#39;mpiCall&#39;</span><span class="p">:</span><span class="n">mpiCall</span><span class="p">,</span>
        <span class="s1">&#39;mpiArg&#39;</span><span class="p">:</span><span class="n">mpiArg</span>
        <span class="p">}</span>
                
        <span class="n">cmd</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{mpiCall}</span><span class="s1"> </span><span class="si">{mpiArg}</span><span class="s1"> </span><span class="si">{cores}</span><span class="s1"> d8hdisttostrm -p </span><span class="si">{fdr}</span><span class="s1"> -src </span><span class="si">{fac}</span><span class="s1"> -dist </span><span class="si">{outRast}</span><span class="s1">, -thresh </span><span class="si">{thresh}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">tauParams</span><span class="p">)</span> <span class="c1"># Create string of tauDEM shell command</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="c1"># Run shell command</span>
        <span class="n">result</span><span class="o">.</span><span class="n">stdout</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Distance raster written to: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">outRast</span><span class="p">))</span>
                
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error computing distances&#39;</span><span class="p">)</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span></div>

<div class="viewcode-block" id="maskStreams"><a class="viewcode-back" href="../functions.html#tools.maskStreams">[docs]</a><span class="k">def</span> <span class="nf">maskStreams</span><span class="p">(</span><span class="n">inRast</span><span class="p">,</span> <span class="n">streamRast</span><span class="p">,</span> <span class="n">outRast</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Mask areas not on the stream network.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    inRast : str</span>
<span class="sd">        Path to the input raster to mask.</span>
<span class="sd">    streamRast : str</span>
<span class="sd">        Path to the stream raster where all non-stream cells are set to no data.</span>
<span class="sd">    outRast : str</span>
<span class="sd">        Path to output raster file.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    outRast : raster</span>
<span class="sd">        Raster with non-stream cells set to the no data value from inRast.</span>
<span class="sd">    &#39;&#39;&#39;</span>
  
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">inRast</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error - Parameter raster file is missing!&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="c1">#Function will fail, so end it now</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">streamRast</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error - Stream raster file is missing!&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="c1">#Function will fail, so end it now</span>


    <span class="k">with</span> <span class="n">rs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">inRast</span><span class="p">)</span> <span class="k">as</span> <span class="n">ds</span><span class="p">:</span> <span class="c1"># load input raster</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">profile</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">profile</span>
        <span class="n">inNoData</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">nodata</span> 

    <span class="k">with</span> <span class="n">rs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">streamRast</span><span class="p">)</span> <span class="k">as</span> <span class="n">ds</span><span class="p">:</span> <span class="c1"># load input raster</span>
        <span class="n">strmVals</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">strmNoData</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">nodata</span> 

    <span class="n">data</span><span class="p">[</span><span class="n">data</span> <span class="o">==</span> <span class="n">inNoData</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span> <span class="c1">#Set no data values to NaN</span>
    <span class="n">data</span><span class="p">[</span><span class="n">strmVals</span> <span class="o">==</span> <span class="n">strmNoData</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span> <span class="c1">#Set values off streams to NaN</span>

    <span class="n">data</span><span class="p">[</span><span class="n">data</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">]</span> <span class="o">=</span> <span class="n">inNoData</span> <span class="c1">#Set NaNs to input no data value</span>

    <span class="c1"># Update raster profile</span>
    <span class="n">profile</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                <span class="s1">&#39;compress&#39;</span><span class="p">:</span><span class="s1">&#39;LZW&#39;</span><span class="p">,</span>
                <span class="s1">&#39;profile&#39;</span><span class="p">:</span><span class="s1">&#39;GeoTIFF&#39;</span><span class="p">,</span>
                <span class="s1">&#39;tiled&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;sparse_ok&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;num_threads&#39;</span><span class="p">:</span><span class="s1">&#39;ALL_CPUS&#39;</span><span class="p">,</span>
                <span class="s1">&#39;nodata&#39;</span><span class="p">:</span><span class="n">inNoData</span><span class="p">,</span>
                <span class="s1">&#39;bigtiff&#39;</span><span class="p">:</span><span class="s1">&#39;IF_SAFER&#39;</span><span class="p">})</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Saving raster </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()))</span>
    <span class="k">with</span> <span class="n">rs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">outRast</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">profile</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
        <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;CPG file written to: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">outRast</span><span class="p">))</span></div>

<div class="viewcode-block" id="resampleParams"><a class="viewcode-back" href="../functions.html#tools.resampleParams">[docs]</a><span class="k">def</span> <span class="nf">resampleParams</span><span class="p">(</span><span class="n">inParams</span><span class="p">,</span> <span class="n">fdr</span><span class="p">,</span> <span class="n">outWorkspace</span><span class="p">,</span> <span class="n">resampleMethod</span><span class="o">=</span><span class="s2">&quot;bilinear&quot;</span><span class="p">,</span> <span class="n">cores</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">appStr</span><span class="o">=</span><span class="s2">&quot;rprj&quot;</span><span class="p">,</span> <span class="n">forceProj</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">forceProj4</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">+proj=aea +lat_1=29.5 +lat_2=45.5 +lat_0=23 +lon_0=-96 +x_0=0 +y_0=0 +ellps=GRS80 +datum=NAD83 +units=m +no_defs</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Batch version of :py:func:`resampleParam`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    inParam : list</span>
<span class="sd">        List of input parameter raster paths.</span>
<span class="sd">    fdr : str</span>
<span class="sd">        Path to the flow direction raster.</span>
<span class="sd">    outWorkspace :  </span>
<span class="sd">        Path to the output directory for the resampled rasters.</span>
<span class="sd">    resampleMethod : str (optional)</span>
<span class="sd">        Resampling method, either bilinear or nearest neighbor. Defaults to bilinear.</span>
<span class="sd">    cores :</span>
<span class="sd">        Number of cores to use. Defaults to 1.</span>
<span class="sd">    appStr : str (optional)</span>
<span class="sd">        String of text to append to the input parameter filenames. Defaults to &quot;rprj.&quot;</span>
<span class="sd">    forceProj : bool (optional)</span>
<span class="sd">        Force the projection of the flow direction raster. This can be useful if the flow direction raster has an unusual projection. Defaults to False.</span>
<span class="sd">    forceProj4 : str (optional)</span>
<span class="sd">        Proj4 string used to force the flow direction raster. This defaults to USGS Albers, but is not used unless the forceProj parameter is set to True.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fileList : list</span>
<span class="sd">        Paths to resampled, reprojected, and clipped parameter rasters.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">fileList</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1">#Initialize list of output files</span>

    <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">inParams</span><span class="p">:</span>

        <span class="n">baseName</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">param</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span> <span class="c1">#Get name of input file without extention</span>

        
        <span class="n">ext</span> <span class="o">=</span> <span class="s2">&quot;.tif&quot;</span> <span class="c1">#File extension</span>

        <span class="n">outPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outWorkspace</span><span class="p">,</span> <span class="n">baseName</span> <span class="o">+</span> <span class="n">appStr</span> <span class="o">+</span> <span class="n">ext</span><span class="p">)</span>
        <span class="n">fileList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">outPath</span><span class="p">)</span>

        <span class="n">resampleParam</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">fdr</span><span class="p">,</span> <span class="n">outPath</span><span class="p">,</span> <span class="n">resampleMethod</span><span class="p">,</span> <span class="n">cores</span><span class="p">,</span> <span class="n">forceProj</span><span class="o">=</span><span class="n">forceProj</span><span class="p">,</span> <span class="n">forceProj4</span><span class="o">=</span><span class="n">forceProj4</span><span class="p">)</span> <span class="c1">#Run the resample function for the parameter raster</span>

    <span class="k">return</span> <span class="n">fileList</span></div>

<div class="viewcode-block" id="accumulateParams"><a class="viewcode-back" href="../functions.html#tools.accumulateParams">[docs]</a><span class="k">def</span> <span class="nf">accumulateParams</span><span class="p">(</span><span class="n">paramRasts</span><span class="p">,</span> <span class="n">fdr</span><span class="p">,</span> <span class="n">outWorkspace</span><span class="p">,</span> <span class="n">cores</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">appStr</span><span class="o">=</span><span class="s2">&quot;accum&quot;</span><span class="p">,</span> <span class="n">mpiCall</span> <span class="o">=</span> <span class="s1">&#39;mpiexec&#39;</span><span class="p">,</span> <span class="n">mpiArg</span> <span class="o">=</span> <span class="s1">&#39;-n&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Batch version of :py:func:`accumulateParam`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    paramRasts : list</span>
<span class="sd">        List of input parameter raster paths to accumulate along the supplied fdr.</span>
<span class="sd">    fdr : str</span>
<span class="sd">        Path to the flow direction raster.</span>
<span class="sd">    outWorkspace : str</span>
<span class="sd">        Path to the output directory for accumulation rasters.</span>
<span class="sd">    cores : int (optional)</span>
<span class="sd">        Number of cores to use. Defaults to 1.</span>
<span class="sd">    appStr :str (optional)</span>
<span class="sd">        String of text to append to accumulated parameter filenames. Defaults to &quot;accum.&quot;</span>
<span class="sd">    mpiCall : str (optional)</span>
<span class="sd">        MPI program to use to execute the program, defaults to mpiexec.</span>
<span class="sd">    mpiArg : str (optional)</span>
<span class="sd">        Argument to pass to mpiCall, defaults to -n.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fileList : list</span>
<span class="sd">        List of file paths to accumulated parameter rasters.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">fileList</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1">#Initialize list of output files</span>
    
    <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">paramRasts</span><span class="p">:</span>

        <span class="n">baseName</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">param</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span> <span class="c1">#Get name of input file without extention</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="s2">&quot;.tif&quot;</span> <span class="c1">#File extension</span>

        <span class="n">outPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outWorkspace</span><span class="p">,</span> <span class="n">baseName</span> <span class="o">+</span> <span class="n">appStr</span> <span class="o">+</span> <span class="n">ext</span><span class="p">)</span>
        <span class="n">fileList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">outPath</span><span class="p">)</span>

        <span class="n">nodataPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outWorkspace</span><span class="p">,</span> <span class="n">baseName</span> <span class="o">+</span> <span class="s2">&quot;nodata&quot;</span> <span class="o">+</span> <span class="n">ext</span><span class="p">)</span> 
        <span class="n">nodataAccumPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outWorkspace</span><span class="p">,</span> <span class="n">baseName</span> <span class="o">+</span> <span class="s2">&quot;nodataaccum&quot;</span> <span class="o">+</span> <span class="n">ext</span><span class="p">)</span> 

        <span class="n">accumulateParam</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">fdr</span><span class="p">,</span> <span class="n">outPath</span><span class="p">,</span> <span class="n">outNoDataRast</span><span class="o">=</span><span class="n">nodataPath</span><span class="p">,</span> <span class="n">outNoDataAccum</span><span class="o">=</span><span class="n">nodataAccumPath</span><span class="p">,</span> <span class="n">cores</span><span class="o">=</span><span class="n">cores</span><span class="p">,</span> <span class="n">mpiCall</span> <span class="o">=</span> <span class="n">mpiCall</span><span class="p">,</span> <span class="n">mpiArg</span> <span class="o">=</span> <span class="n">mpiArg</span><span class="p">)</span> <span class="c1">#Run the flow accumulation function for the parameter raster</span>

    <span class="k">return</span> <span class="n">fileList</span></div>

<div class="viewcode-block" id="make_fcpgs"><a class="viewcode-back" href="../functions.html#tools.make_fcpgs">[docs]</a><span class="k">def</span> <span class="nf">make_fcpgs</span><span class="p">(</span><span class="n">accumParams</span><span class="p">,</span> <span class="n">fac</span><span class="p">,</span> <span class="n">outWorkspace</span><span class="p">,</span> <span class="n">minAccum</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">appStr</span><span class="o">=</span><span class="s2">&quot;FCPG&quot;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Batch version of :py:func:`make_fcpg`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    accumParams : list</span>
<span class="sd">        List of accumulated parameter rasters to create FCPGs from.</span>
<span class="sd">    fac : str</span>
<span class="sd">        Path to the flow accumulation raster.</span>
<span class="sd">    outWorkspace : str</span>
<span class="sd">        Path to an output directory for produced FCPGs.</span>
<span class="sd">    minAccum : int (optional)</span>
<span class="sd">        Minimum accumulation value below which the output FCPG will be turned to no data values. Defaults to None.</span>
<span class="sd">    appStr : str (optional)</span>
<span class="sd">        String of text to append to filenames of the produced FCPG grids.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fileList : list</span>
<span class="sd">        List of file paths to the produced FCPGs.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">fileList</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1">#Initialize list of output files</span>

    <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">accumParams</span><span class="p">:</span>

        <span class="n">baseName</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">param</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span> <span class="c1">#Get name of input file without extention</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="s2">&quot;.tif&quot;</span> <span class="c1">#File extension</span>

        <span class="n">outPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outWorkspace</span><span class="p">,</span> <span class="n">baseName</span> <span class="o">+</span> <span class="n">appStr</span> <span class="o">+</span> <span class="n">ext</span><span class="p">)</span>
        <span class="n">fileList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">outPath</span><span class="p">)</span>

        <span class="n">make_fcpg</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">fac</span><span class="p">,</span> <span class="n">outPath</span><span class="p">,</span> <span class="n">minAccum</span><span class="o">=</span><span class="n">minAccum</span><span class="p">)</span> <span class="c1">#Run the CPG function for the accumulated parameter raster</span>

    <span class="k">return</span> <span class="n">fileList</span></div>

<div class="viewcode-block" id="cat2bin"><a class="viewcode-back" href="../functions.html#tools.cat2bin">[docs]</a><span class="k">def</span> <span class="nf">cat2bin</span><span class="p">(</span><span class="n">inCat</span><span class="p">,</span> <span class="n">outWorkspace</span><span class="p">,</span> <span class="n">par</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Turn a categorical raster (e.g. land cover type) into a set of binary rasters, one for each category in the supplied raster, zero for areas where that class is not present, 1 for areas where that class is present, and -1 for regions of no data in the supplied raster. Wrapper on :py:func:`binarizeCat`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    inCat : str</span>
<span class="sd">        Input catagorical parameter raster.</span>
<span class="sd">    outWorkspace : str</span>
<span class="sd">        Workspace to save binary raster output files.</span>
<span class="sd">    par : bool</span>
<span class="sd">        Use parallel processing to generate binary rasters.</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fileList : list</span>
<span class="sd">        List of filepaths to output files.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Creating binaries for </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">inCat</span><span class="p">)</span>
    
    <span class="n">baseName</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">inCat</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span> <span class="c1">#Get name of input file without extention</span>
    

    <span class="c1"># load input data</span>
    <span class="k">with</span> <span class="n">rs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">inCat</span><span class="p">)</span> <span class="k">as</span> <span class="n">ds</span><span class="p">:</span>
        <span class="n">dat</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">profile</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1"># save the metadata for output later</span>
        <span class="n">nodata</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">nodata</span>
    
    <span class="n">cats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span> <span class="c1"># Get unique values in raster</span>
    <span class="n">cats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">cats</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cats</span> <span class="o">==</span>  <span class="n">nodata</span><span class="p">))</span> <span class="c1"># Remove no data value from list</span>

    <span class="n">fileList</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1">#Initialize list of output files</span>

    <span class="c1"># edit the metadata</span>
    <span class="n">profile</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;dtype&#39;</span><span class="p">:</span><span class="s1">&#39;int8&#39;</span><span class="p">,</span>
                <span class="s1">&#39;compress&#39;</span><span class="p">:</span><span class="s1">&#39;LZW&#39;</span><span class="p">,</span>
                <span class="s1">&#39;profile&#39;</span><span class="p">:</span><span class="s1">&#39;GeoTIFF&#39;</span><span class="p">,</span>
                <span class="s1">&#39;tiled&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;sparse_ok&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;num_threads&#39;</span><span class="p">:</span><span class="s1">&#39;ALL_CPUS&#39;</span><span class="p">,</span>
                <span class="s1">&#39;nodata&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="c1">#Use -1 as no data value</span>
                <span class="s1">&#39;bigtiff&#39;</span><span class="p">:</span><span class="s1">&#39;IF_SAFER&#39;</span><span class="p">})</span>
    
    <span class="n">ext</span> <span class="o">=</span> <span class="s2">&quot;.tif&quot;</span> <span class="c1">#Output file extension</span>

    <span class="c1">#Create binary rasters for each category</span>
    <span class="k">if</span> <span class="n">par</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">partial</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="n">processPool</span><span class="p">()</span>

        <span class="c1"># Use pool.map() to create binaries in parallel</span>
        <span class="n">fileList</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="n">binarizeCat</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">dat</span><span class="p">,</span> <span class="n">nodata</span><span class="o">=</span><span class="n">nodata</span><span class="p">,</span> <span class="n">outWorkspace</span><span class="o">=</span><span class="n">outWorkspace</span><span class="p">,</span> <span class="n">baseName</span><span class="o">=</span><span class="n">baseName</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="n">ext</span><span class="p">,</span> <span class="n">profile</span><span class="o">=</span><span class="n">profile</span><span class="p">),</span> <span class="n">cats</span><span class="p">)</span>

        <span class="c1">#close the pool and wait for the work to finish</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fileList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">cat</span> <span class="ow">in</span> <span class="n">cats</span><span class="p">:</span>
            <span class="n">fileList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">binarizeCat</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">dat</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="n">cat</span><span class="p">,</span> <span class="n">nodata</span> <span class="o">=</span> <span class="n">nodata</span><span class="p">,</span> <span class="n">outWorkspace</span> <span class="o">=</span> <span class="n">outWorkspace</span><span class="p">,</span> <span class="n">baseName</span> <span class="o">=</span> <span class="n">baseName</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">ext</span><span class="p">,</span> <span class="n">profile</span> <span class="o">=</span> <span class="n">profile</span><span class="p">))</span>
    
    <span class="k">return</span> <span class="n">fileList</span></div>

<div class="viewcode-block" id="binarizeCat"><a class="viewcode-back" href="../functions.html#tools.binarizeCat">[docs]</a><span class="k">def</span> <span class="nf">binarizeCat</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">nodata</span><span class="p">,</span> <span class="n">outWorkspace</span><span class="p">,</span> <span class="n">baseName</span><span class="p">,</span> <span class="n">ext</span><span class="p">,</span> <span class="n">profile</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Turn a categorical raster (e.g. land cover type) into a set of binary rasters, one for each category in the supplied raster, zero for areas where that class is not present, 1 for areas where that class is present, and -1 for regions of no data in the supplied raster. See also :py:func:`cat2bin`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : np.array</span>
<span class="sd">        Numpy array of raster data to convert to binary.</span>
<span class="sd">    val : int</span>
<span class="sd">        Raster value to extract binary for from data.</span>
<span class="sd">    nodata : int or float</span>
<span class="sd">        Raster no data value.</span>
<span class="sd">    outWorkspace : str</span>
<span class="sd">        Path to folder to save binary output rasters to.</span>
<span class="sd">    baseName : str</span>
<span class="sd">        Base name for the output rasters.</span>
<span class="sd">    ext : str</span>
<span class="sd">        File extension for output rasters.</span>
<span class="sd">    profile : dict</span>
<span class="sd">    	Rasterio metadata dictionary decribing the properties used to create the output raster.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    catRaster : str</span>
<span class="sd">        Filepath to the binary raster created.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">catData</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">catData</span><span class="p">[(</span><span class="n">data</span> <span class="o">!=</span> <span class="n">val</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">data</span> <span class="o">!=</span> <span class="n">nodata</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">catData</span><span class="p">[</span><span class="n">data</span> <span class="o">==</span> <span class="n">val</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">catData</span><span class="p">[</span><span class="n">data</span> <span class="o">==</span> <span class="n">nodata</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="c1">#Use -1 as no data value</span>
    <span class="n">catData</span> <span class="o">=</span> <span class="n">catData</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int8&#39;</span><span class="p">)</span><span class="c1">#8 bit integer is sufficient for zeros and ones</span>

    <span class="n">catRasterName</span> <span class="o">=</span> <span class="n">baseName</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">+</span> <span class="n">ext</span>
    <span class="n">catRaster</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outWorkspace</span><span class="p">,</span> <span class="n">catRasterName</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Saving </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">catRaster</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">rs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">catRaster</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">,</span><span class="o">**</span><span class="n">profile</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
        <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">catData</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">catRaster</span> <span class="c1"># Return the path to the raster created</span></div>

<div class="viewcode-block" id="tauFlowAccum"><a class="viewcode-back" href="../functions.html#tools.tauFlowAccum">[docs]</a><span class="k">def</span> <span class="nf">tauFlowAccum</span><span class="p">(</span><span class="n">fdr</span><span class="p">,</span> <span class="n">accumRast</span><span class="p">,</span> <span class="n">cores</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mpiCall</span> <span class="o">=</span> <span class="s1">&#39;mpiexec&#39;</span><span class="p">,</span> <span class="n">mpiArg</span> <span class="o">=</span> <span class="s1">&#39;-n&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Wrapper for TauDEM AreaD8 :cite:`TauDEM` to produce a flow acculation grid.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fdr : str</span>
<span class="sd">        Path to a flow direction raster in TauDEM format.</span>
<span class="sd">    accumRast : str</span>
<span class="sd">        Path to output the flow accumulation raster.</span>
<span class="sd">    cores : int (optional)</span>
<span class="sd">        Number of cores to use. Defaults to 1.</span>
<span class="sd">    mpiCall : str (optional)</span>
<span class="sd">        The command to use for mpi, defaults to mpiexec.</span>
<span class="sd">    mpiArg : str (optional)</span>
<span class="sd">        Argument flag passed to mpiCall, which is followed by the cores parameter.</span>


<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    accumRast : raster</span>
<span class="sd">        Raster of accumulated parameter values at the path specified above.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#Use tauDEM to accumulate the parameter</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Accumulating Data...&#39;</span><span class="p">)</span>
        <span class="n">tauParams</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;fdr&#39;</span><span class="p">:</span><span class="n">fdr</span><span class="p">,</span>
        <span class="s1">&#39;cores&#39;</span><span class="p">:</span><span class="n">cores</span><span class="p">,</span> 
        <span class="s1">&#39;outFl&#39;</span><span class="p">:</span><span class="n">accumRast</span><span class="p">,</span>
        <span class="s1">&#39;mpiCall&#39;</span><span class="p">:</span><span class="n">mpiCall</span><span class="p">,</span>
        <span class="s1">&#39;mpiArg&#39;</span><span class="p">:</span><span class="n">mpiArg</span>
        <span class="p">}</span>
        
        <span class="n">cmd</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{mpiCall}</span><span class="s1"> </span><span class="si">{mpiArg}</span><span class="s1"> </span><span class="si">{cores}</span><span class="s1"> aread8 -p </span><span class="si">{fdr}</span><span class="s1"> -ad8 </span><span class="si">{outFl}</span><span class="s1"> -nc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">tauParams</span><span class="p">)</span> <span class="c1"># Create string of tauDEM shell command</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="c1"># Run shell command</span>
        
        <span class="n">result</span><span class="o">.</span><span class="n">stdout</span>
        
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error Accumulating Data&#39;</span><span class="p">)</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span></div>

<div class="viewcode-block" id="ExtremeUpslopeValue"><a class="viewcode-back" href="../functions.html#tools.ExtremeUpslopeValue">[docs]</a><span class="k">def</span> <span class="nf">ExtremeUpslopeValue</span><span class="p">(</span><span class="n">fdr</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">accum_type</span> <span class="o">=</span> <span class="s2">&quot;MAX&quot;</span><span class="p">,</span> <span class="n">cores</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fac</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">thresh</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Wrapper for the TauDEM D8 Extreme Upslope Value function :cite:`TauDEM`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fdr : str</span>
<span class="sd">        Path to a flow direction grid in TauDEM format.</span>
<span class="sd">    param : str</span>
<span class="sd">        Path to parameter raster to run through the D8 Extreme Upslope Value tool</span>
<span class="sd">    output : str</span>
<span class="sd">        Path to output raster file.</span>
<span class="sd">    accum_type : str (optional) </span>
<span class="sd">        Either  &quot;MAX&quot; or &quot;MIN.&quot; Defaults to &quot;MAX.&quot;</span>
<span class="sd">    cores : int (optional) </span>
<span class="sd">        Number of cores to run this process on. Defaults to 1.</span>
<span class="sd">    fac : str (optional)</span>
<span class="sd">        Path to a flow accumulation raster. Defaults to None.</span>
<span class="sd">    thresh : int (optional)</span>
<span class="sd">        Threshold values, in the same units as fac to mask output to stream channels. Defaults to None.</span>
<span class="sd">    mpiCall : str (optional)</span>
<span class="sd">        The command to use for mpi, defaults to mpiexec.</span>
<span class="sd">    mpiArg : str (optional)</span>
<span class="sd">        Argument flag passed to mpiCall, which is followed by the cores parameter.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    output : raster</span>
<span class="sd">        Raster of either the maximum or minumum upslope value of the parameter grid supplied to the function.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    

    <span class="n">tauParams</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;fdr&#39;</span><span class="p">:</span><span class="n">fdr</span><span class="p">,</span>
        <span class="s1">&#39;cores&#39;</span><span class="p">:</span><span class="n">cores</span><span class="p">,</span> 
        <span class="s1">&#39;outFl&#39;</span><span class="p">:</span><span class="n">output</span><span class="p">,</span>
        <span class="s1">&#39;param&#39;</span><span class="p">:</span><span class="n">param</span><span class="p">,</span>
        <span class="s1">&#39;accum_type&#39;</span><span class="p">:</span><span class="n">accum_type</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
        <span class="s1">&#39;mpiCall&#39;</span><span class="p">:</span><span class="n">mpiCall</span><span class="p">,</span>
        <span class="s1">&#39;mpiArg&#39;</span><span class="p">:</span><span class="n">mpiArg</span>
        <span class="p">}</span>

    <span class="k">if</span> <span class="n">accum_type</span> <span class="o">==</span> <span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="c1"># insert flag for min </span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{mpiCall}</span><span class="s1"> </span><span class="si">{mpiArg}</span><span class="s1"> </span><span class="si">{cores}</span><span class="s1"> d8flowpathextremeup -p </span><span class="si">{fdr}</span><span class="s1"> -sa </span><span class="si">{param}</span><span class="s1"> -ssa </span><span class="si">{outFl}</span><span class="s1"> -</span><span class="si">{accum_type}</span><span class="s1"> -nc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">tauParams</span><span class="p">)</span> <span class="c1"># Create string of tauDEM shell command</span>
    <span class="k">else</span><span class="p">:</span> <span class="c1"># no flag for max</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{mpiCall}</span><span class="s1"> </span><span class="si">{mpiArg}</span><span class="s1"> </span><span class="si">{cores}</span><span class="s1"> d8flowpathextremeup -p </span><span class="si">{fdr}</span><span class="s1"> -sa </span><span class="si">{param}</span><span class="s1"> -ssa </span><span class="si">{outFl}</span><span class="s1"> -nc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">tauParams</span><span class="p">)</span> <span class="c1"># Create string of tauDEM shell command</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="c1"># print the command to be run to the output.</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="c1"># Run shell command</span>
        
    <span class="n">result</span><span class="o">.</span><span class="n">stdout</span>

    <span class="k">if</span> <span class="n">fac</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">thresh</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># if a stream mask is specified</span>
        <span class="n">outNoData</span> <span class="o">=</span> <span class="o">-</span><span class="mi">9999</span>

        <span class="k">with</span> <span class="n">rs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
            <span class="n">dat</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">noData</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">nodata</span>
            <span class="n">dat</span><span class="p">[</span><span class="n">dat</span> <span class="o">==</span> <span class="n">noData</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
            
        <span class="k">del</span> <span class="n">src</span>

        <span class="k">with</span> <span class="n">rs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fac</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
            <span class="n">fac</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">fac</span><span class="p">[</span><span class="n">fac</span> <span class="o">==</span> <span class="n">src</span><span class="o">.</span><span class="n">nodata</span><span class="p">]</span> <span class="o">=</span> <span class="n">outNoData</span>

        <span class="k">del</span> <span class="n">src</span>

        <span class="n">dat</span><span class="p">[</span><span class="n">fac</span> <span class="o">&lt;</span> <span class="n">thresh</span><span class="p">]</span> <span class="o">=</span> <span class="n">outNoData</span> <span class="c1"># make low accumulation areas noData</span>
        <span class="n">dat</span><span class="p">[</span><span class="n">fac</span> <span class="o">==</span> <span class="n">outNoData</span><span class="p">]</span> <span class="o">=</span> <span class="n">outNoData</span> <span class="c1"># make borders noData</span>

        <span class="n">params</span><span class="p">[</span><span class="s1">&#39;nodata&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">outNoData</span>

        <span class="k">with</span> <span class="n">rs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">output</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">,</span><span class="o">**</span><span class="n">params</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span> <span class="c1"># write out raster.</span>
            <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="getFeatures"><a class="viewcode-back" href="../functions.html#tools.getFeatures">[docs]</a><span class="k">def</span> <span class="nf">getFeatures</span><span class="p">(</span><span class="n">gdf</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Helper function to parse features from a GeoPandas GeoDataframe in such a manner that Rasterio can handle them.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    gdf : GeoDataframe</span>
<span class="sd">        GeoPandas GeoDataframe with a geometry column.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    features : geoJSON</span>
<span class="sd">        GeoJSON representation of geometry features from the input GeoDataFrame.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">import</span> <span class="nn">json</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">gdf</span><span class="o">.</span><span class="n">to_json</span><span class="p">())[</span><span class="s1">&#39;features&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;geometry&#39;</span><span class="p">]]</span></div>

<div class="viewcode-block" id="getHUC4"><a class="viewcode-back" href="../functions.html#tools.getHUC4">[docs]</a><span class="k">def</span> <span class="nf">getHUC4</span><span class="p">(</span><span class="n">HUC12</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Helper function to return HUC4 representation from a HUC12 identifier.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    HUC12 : str</span>
<span class="sd">        Text representation of the HUC12 identifier.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    HUC4 : str</span>
<span class="sd">        HUC4 identifier.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">HUC12</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span></div>

<div class="viewcode-block" id="makePourBasins"><a class="viewcode-back" href="../functions.html#tools.makePourBasins">[docs]</a><span class="k">def</span> <span class="nf">makePourBasins</span><span class="p">(</span><span class="n">wbd</span><span class="p">,</span><span class="n">fromHUC4</span><span class="p">,</span><span class="n">toHUC4</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Make geodataframe of HUC12 basis flowing from fromHUC4 to toHUC4.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    wbd : GeoDataframe</span>
<span class="sd">        HUC12-level geodataframe projected to the same coordinate reference system (CRS) as the flow accumulation (FAC) and flow direction (FDR) grids being used.</span>
<span class="sd">    fromHUC4 : str</span>
<span class="sd">        HUC4 string for the upstream basin.</span>
<span class="sd">    toHUC4 : str</span>
<span class="sd">        HUC string for the downstream basin.</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pourBasins : GeoDataframe</span>
<span class="sd">        HUC12-level geodataframe of units that drain from fromHUC4 to toHUC4.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="n">wbd</span><span class="p">[</span><span class="s1">&#39;HUC4&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wbd</span><span class="o">.</span><span class="n">HUC12</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">getHUC4</span><span class="p">)</span>
    <span class="n">wbd</span><span class="p">[</span><span class="s1">&#39;ToHUC4&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wbd</span><span class="o">.</span><span class="n">ToHUC</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">getHUC4</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">wbd</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">wbd</span><span class="o">.</span><span class="n">HUC4</span> <span class="o">==</span> <span class="n">fromHUC4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">wbd</span><span class="o">.</span><span class="n">ToHUC4</span> <span class="o">==</span> <span class="n">toHUC4</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span></div>

<div class="viewcode-block" id="findPourPoints"><a class="viewcode-back" href="../functions.html#tools.findPourPoints">[docs]</a><span class="k">def</span> <span class="nf">findPourPoints</span><span class="p">(</span><span class="n">pourBasins</span><span class="p">,</span> <span class="n">upfacfl</span><span class="p">,</span> <span class="n">upfdrfl</span><span class="p">,</span> <span class="n">plotBasins</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Finds unique pour points between two HUC4s.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pourBasins : GeoDataframe</span>
<span class="sd">        GeoDataframe of the HUC12 basins that flow into the downstream HUC4. Used to clip the upstream FAC grid to identify pour points.</span>
<span class="sd">    upfacfl : str</span>
<span class="sd">        Path to the upstream flow accumulation grid.</span>
<span class="sd">    upfdrfl : str</span>
<span class="sd">        Path to the upstream tauDEM flow direction grid.</span>
<span class="sd">    plotBasins : bool (Optional)</span>
<span class="sd">        Boolean to make plots of upstream HUC12s and identified pour points. Defaults to False.</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    finalPoints : list</span>
<span class="sd">        List of tuples containing (x,y,w). These pour points have not been incremented downstream and can be used to query accumulated (but not FCPGed) upstream parameter grids for information to cascade down to the next hydrologic region / geospatial tile downstream. </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">pourPoints</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pourBasins</span><span class="p">)):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">upfacfl</span><span class="p">)</span> <span class="c1"># open the FAC grid</span>

        <span class="c1"># make a shape out of the HUC boundary</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">pourBasins</span><span class="o">.</span><span class="n">iloc</span><span class="p">[[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">row</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>

        <span class="n">coords</span> <span class="o">=</span> <span class="n">getFeatures</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

        <span class="n">out_img</span><span class="p">,</span> <span class="n">out_transform</span> <span class="o">=</span> <span class="n">mask</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">shapes</span><span class="o">=</span><span class="n">coords</span><span class="p">,</span> <span class="n">crop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># get the raster for the HUC</span>

        <span class="n">cx</span><span class="p">,</span><span class="n">cy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">out_img</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">out_img</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span> <span class="c1"># find the location of max values</span>

        <span class="n">w</span> <span class="o">=</span> <span class="n">out_img</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="c1"># get the value to propagate to the downstream grid.</span>

        <span class="n">newx</span><span class="p">,</span><span class="n">newy</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">xy</span><span class="p">(</span><span class="n">out_transform</span><span class="p">,</span><span class="n">cx</span><span class="p">,</span><span class="n">cy</span><span class="p">)</span> <span class="c1"># convert the row, column locations to coordinates given the new affine</span>

        <span class="c1"># zip the coordinates to points, when moved downstream, only one of these should land on a no data pixel</span>
        <span class="n">points</span> <span class="o">=</span> <span class="p">[(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">)</span> <span class="k">for</span> <span class="n">nx</span><span class="p">,</span><span class="n">ny</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">newx</span><span class="p">,</span><span class="n">newy</span><span class="p">)]</span>

        <span class="c1"># test if a point lands on a noData pixel.</span>
        <span class="c1">#print(len(points))</span>
        <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">points</span><span class="p">:</span>
            <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="o">=</span> <span class="n">point</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">queryPoint</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">upfdrfl</span><span class="p">)</span>
            <span class="n">newx</span><span class="p">,</span><span class="n">newy</span> <span class="o">=</span> <span class="n">FindDownstreamCellTauDir</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">out_transform</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="c1">#if queryPoint(newx,newy,upfacfl) == data.meta[&#39;nodata&#39;]:</span>
            <span class="n">pourPoints</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">newx</span><span class="p">,</span><span class="n">newy</span><span class="p">,</span><span class="n">w</span><span class="p">))</span> <span class="c1"># keep the point if it does. Original points retained</span>
            <span class="c1">#print(pourPoints)</span>
    
    <span class="k">if</span> <span class="n">plotBasins</span><span class="p">:</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">pourBasins</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;Name&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">px</span><span class="p">,</span><span class="n">py</span><span class="p">,</span><span class="n">pw</span> <span class="ow">in</span> <span class="n">pourPoints</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">px</span><span class="p">,</span><span class="n">py</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    
    <span class="c1"># get the unique pour points...</span>
    <span class="n">xs</span><span class="p">,</span><span class="n">ys</span><span class="p">,</span><span class="n">ws</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">pourPoints</span><span class="p">)</span>

    <span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span>
    <span class="n">ys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span>
    <span class="n">ws</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ws</span><span class="p">)</span>

    <span class="n">pts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">w</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span><span class="n">ys</span><span class="p">,</span><span class="n">ws</span><span class="p">):</span>
        <span class="n">pts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s%s%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">w</span><span class="p">))</span>

    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">pts</span><span class="p">,</span><span class="n">return_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="c1"># use the indicies to make a set of final pour points</span>
    <span class="n">finalPoints</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">w</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">xs</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span><span class="n">ys</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span><span class="n">ws</span><span class="p">[</span><span class="n">idx</span><span class="p">]):</span>
        <span class="n">finalPoints</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">w</span><span class="p">))</span>
        
    <span class="k">return</span> <span class="n">finalPoints</span></div>

<div class="viewcode-block" id="loadRaster"><a class="viewcode-back" href="../functions.html#tools.loadRaster">[docs]</a><span class="k">def</span> <span class="nf">loadRaster</span><span class="p">(</span><span class="n">fl</span><span class="p">,</span> <span class="n">returnMeta</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">band</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Helper function to load raster data and metadata.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fl : str</span>
<span class="sd">        Path to the raster file to load.</span>
<span class="sd">    returnMeta : bool (Optional)</span>
<span class="sd">        Return the raster metadata. Defaults to False.</span>
<span class="sd">    band : int (Optional)</span>
<span class="sd">        Band to read from the raster. Defaults to one.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dat : np.array</span>
<span class="sd">        Numpy array of the data in the selected raster band.</span>
<span class="sd">    meta : dict</span>
<span class="sd">        Dictionary of raster metadata.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">rs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fl</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
            <span class="n">dat</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">band</span><span class="p">)</span>
            <span class="n">meta</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">returnMeta</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">dat</span><span class="p">,</span> <span class="n">meta</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">dat</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unable to open </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">fl</span><span class="p">))</span></div>

<div class="viewcode-block" id="findLastFACFD"><a class="viewcode-back" href="../functions.html#tools.findLastFACFD">[docs]</a><span class="k">def</span> <span class="nf">findLastFACFD</span><span class="p">(</span><span class="n">facfl</span><span class="p">,</span> <span class="n">fl</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Find the coordinate of the greatest cell in facfl, return the value from fl at that point.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    facfl : str</span>
<span class="sd">        Path to a flow accumulation grid.</span>
<span class="sd">    fl : str (optional)</span>
<span class="sd">        Path to an accumulated parameter file. Defaults to None. If None, the facfl is queried.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    x : float</span>
<span class="sd">        Horizontal coordinate of the greatest FAC cell.</span>
<span class="sd">    y : float</span>
<span class="sd">        Vertical coordinate of the greatest FAC cell.</span>
<span class="sd">    d : float</span>
<span class="sd">        Value from the parameter grid queried.</span>
<span class="sd">    w : float</span>
<span class="sd">        Cell size of the grid.</span>


<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    This can be used to find the flow direction of the FAC cell with the greatest accumulation value or the parameter value of the cell with the greatest accumulation value.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="n">fac</span><span class="p">,</span><span class="n">meta</span> <span class="o">=</span> <span class="n">loadRaster</span><span class="p">(</span><span class="n">facfl</span><span class="p">,</span><span class="n">returnMeta</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># load the fac file</span>
    
    <span class="k">if</span> <span class="n">fl</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dat</span> <span class="o">=</span> <span class="n">fac</span> <span class="c1"># use the fac raster as the parameter grid to query.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dat</span> <span class="o">=</span> <span class="n">loadRaster</span><span class="p">(</span><span class="n">fl</span><span class="p">)</span> <span class="c1"># load the data file</span>

    <span class="n">cx</span><span class="p">,</span><span class="n">cy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">fac</span><span class="o">==</span><span class="n">fac</span><span class="o">.</span><span class="n">max</span><span class="p">())</span> <span class="c1"># find the column, row cooridnates of the max fac.</span>
    
    <span class="n">d</span> <span class="o">=</span> <span class="n">dat</span><span class="p">[</span><span class="n">cx</span><span class="p">,</span><span class="n">cy</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># query the parameter grid</span>
    
    <span class="n">src</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">facfl</span><span class="p">)</span> <span class="c1"># open the fac dataset</span>
    <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">xy</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span><span class="n">cy</span><span class="p">)</span> <span class="c1"># convert the column, row coordinates to map coordinates</span>
    
    <span class="n">w</span> <span class="o">=</span> <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;transform&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># get the cell size of the grid</span>
    
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">float</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">float</span><span class="p">(</span><span class="n">d</span><span class="p">),</span><span class="nb">float</span><span class="p">(</span><span class="n">w</span><span class="p">)</span></div>

<div class="viewcode-block" id="queryPoint"><a class="viewcode-back" href="../functions.html#tools.queryPoint">[docs]</a><span class="k">def</span> <span class="nf">queryPoint</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">grd</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Query grid based on a supplied point.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x : float or int</span>
<span class="sd">        Horizontal coordinate in grid projection.</span>
<span class="sd">    y : float or int</span>
<span class="sd">        Vertical coordinate in grid projection.</span>
<span class="sd">    grd : str</span>
<span class="sd">        Path to raster to query based on the supplied x and y coordinates.</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    value : float or int</span>
<span class="sd">        Value queried from the supplied raster.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="c1"># loop construct is to deal with src.sample returning an array, only the value is needed.</span>
    <span class="k">with</span> <span class="n">rs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">grd</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">src</span><span class="o">.</span><span class="n">sample</span><span class="p">([(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)],</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="FindDownstreamCellTauDir"><a class="viewcode-back" href="../functions.html#tools.FindDownstreamCellTauDir">[docs]</a><span class="k">def</span> <span class="nf">FindDownstreamCellTauDir</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">w</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Find downstream cell given the flow direction of a reference cell using TauDEM flow directions.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    d : int</span>
<span class="sd">        Flow direction of the reference cell.</span>
<span class="sd">    x : float</span>
<span class="sd">        Horizontal coordinate (either projected or unprojected).</span>
<span class="sd">    y : float</span>
<span class="sd">        Vertical coordinate (either projected or unprojected).</span>
<span class="sd">    w : float</span>
<span class="sd">        Cell size, in map units.</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    x : float</span>
<span class="sd">        Horizontal coordinate of the downstream cell.</span>
<span class="sd">    y : float</span>
<span class="sd">        Vertical coordinate of the downstream cell.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="c1"># figure out how to correct the point location</span>
    <span class="k">if</span> <span class="n">d</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># east</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">w</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">elif</span> <span class="n">d</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> <span class="c1"># northeast</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">w</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">w</span>
    <span class="k">elif</span> <span class="n">d</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span> <span class="c1"># north</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">w</span>
    <span class="k">elif</span> <span class="n">d</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span> <span class="c1"># northwest</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">w</span><span class="o">*-</span><span class="mf">1.</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">w</span>
    <span class="k">elif</span> <span class="n">d</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span> <span class="c1"># west</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">w</span><span class="o">*-</span><span class="mf">1.</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">elif</span> <span class="n">d</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span> <span class="c1"># southwest</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">w</span><span class="o">*-</span><span class="mf">1.</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">w</span><span class="o">*-</span><span class="mf">1.</span>
    <span class="k">elif</span> <span class="n">d</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span> <span class="c1"># south</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">w</span><span class="o">*-</span><span class="mf">1.</span>
    <span class="k">elif</span> <span class="n">d</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span> <span class="c1"># southeast</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">w</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">w</span><span class="o">*-</span><span class="mf">1.</span>
        
    <span class="c1"># update the location</span>
    <span class="n">newX</span> <span class="o">=</span> <span class="n">x</span><span class="o">+</span><span class="n">dx</span>
    <span class="n">newY</span> <span class="o">=</span> <span class="n">y</span><span class="o">+</span><span class="n">dy</span>
    
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">newX</span><span class="p">),</span><span class="nb">float</span><span class="p">(</span><span class="n">newY</span><span class="p">)</span></div>

<div class="viewcode-block" id="saveJSON"><a class="viewcode-back" href="../functions.html#tools.saveJSON">[docs]</a><span class="k">def</span> <span class="nf">saveJSON</span><span class="p">(</span><span class="n">dictionary</span><span class="p">,</span> <span class="n">outfl</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Save dictionary to JSON file.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dictionary : dict</span>
<span class="sd">        Dictionary to be saved.</span>
<span class="sd">    outfl : str</span>
<span class="sd">        Path for where to generate the JSON</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># Write JSON file</span>
    <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">outfl</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
        <span class="n">str_</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">dictionary</span><span class="p">,</span>
                      <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;: &#39;</span><span class="p">),</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">to_unicode</span><span class="p">(</span><span class="n">str_</span><span class="p">))</span>
    
    <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="loadJSON"><a class="viewcode-back" href="../functions.html#tools.loadJSON">[docs]</a><span class="k">def</span> <span class="nf">loadJSON</span><span class="p">(</span><span class="n">infl</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Load dictionary stored in a JSON file.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    infl : str</span>
<span class="sd">        Path to the JSON to be loaded.</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dictionary : dict</span>
<span class="sd">        Dictionary that was loaded.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># Read JSON file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">infl</span><span class="p">)</span> <span class="k">as</span> <span class="n">data_file</span><span class="p">:</span>
        <span class="n">dictionary</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">data_file</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">dictionary</span></div>

<div class="viewcode-block" id="createUpdateDict"><a class="viewcode-back" href="../functions.html#tools.createUpdateDict">[docs]</a><span class="k">def</span> <span class="nf">createUpdateDict</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">upstreamFACmax</span><span class="p">,</span> <span class="n">fromHUC</span><span class="p">,</span> <span class="n">outfl</span><span class="p">,</span> <span class="n">replaceDict</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Create a dictionary for updating downstream FAC and parameter grids using values pulled from the next grid upstream.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x : list</span>
<span class="sd">        Horizontal coordinate(s) for where the update needs to happen in the downstream grid. </span>
<span class="sd">    y : list</span>
<span class="sd">        Vertical coordinate(s) for where the update needs to happen in the downstream grid.</span>
<span class="sd">    upstreamFACmax : list</span>
<span class="sd">        Value(s) to insert into the downstream FAC grid.</span>
<span class="sd">    fromHUC : str</span>
<span class="sd">        The upstream HUC that the values are coming from.</span>
<span class="sd">    outfl : str (path)</span>
<span class="sd">        Path to where to save the json of this dictionary. The convention is to name this by the downstream HUC.</span>
<span class="sd">    replaceDict : bool (optional)</span>
<span class="sd">        Replace the update dictionary instead of updating with a new value. Defaults to True.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    updateDict : dict</span>
<span class="sd">        Update dictionary that is also written to outfl.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="c1"># using lists instead of single values in case there are multiple pour points between basins</span>
    
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span><span class="p">:</span>
    	<span class="n">x</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span><span class="p">:</span>
    	<span class="n">y</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">upstreamFACmax</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span><span class="p">:</span>
    	<span class="n">upstreamFACmax</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">upstreamFACmax</span><span class="p">)</span>

    <span class="c1"># convert lists to strings</span>
    <span class="n">xs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">xx</span><span class="p">)</span> <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>
    <span class="n">ys</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">yy</span><span class="p">)</span> <span class="k">for</span> <span class="n">yy</span> <span class="ow">in</span> <span class="n">y</span><span class="p">]</span>
    <span class="n">facs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">fac</span><span class="p">)</span> <span class="k">for</span> <span class="n">fac</span> <span class="ow">in</span> <span class="n">upstreamFACmax</span><span class="p">]</span>
    
    <span class="n">subDict</span> <span class="o">=</span> <span class="p">{</span> <span class="c1"># make dictionary for the upstream FAC</span>
        <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="n">xs</span><span class="p">,</span>
        <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">ys</span><span class="p">,</span>
        <span class="s1">&#39;maxUpstreamFAC&#39;</span><span class="p">:</span><span class="n">facs</span><span class="p">,</span>
        <span class="s1">&#39;vars&#39;</span><span class="p">:[</span><span class="s1">&#39;maxUpstreamFAC&#39;</span><span class="p">]</span> <span class="c1"># list of contained parameters</span>
                <span class="p">}</span>
    
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outfl</span><span class="p">)</span> <span class="ow">and</span> <span class="n">replaceDict</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span> <span class="c1"># if the update dictionary exists, update it.</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Update dictionary found: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">outfl</span><span class="p">)</span>
        <span class="n">updateDict</span> <span class="o">=</span> <span class="n">loadJSON</span><span class="p">(</span><span class="n">outfl</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Updating dictionary...&#39;</span><span class="p">)</span>
        <span class="n">updateDict</span><span class="p">[</span><span class="n">fromHUC</span><span class="p">]</span> <span class="o">=</span> <span class="n">subDict</span>
    <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outfl</span><span class="p">)</span> <span class="ow">and</span> <span class="n">replaceDict</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">outfl</span><span class="p">)</span>
        <span class="n">updateDict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">fromHUC</span> <span class="p">:</span> <span class="n">subDict</span>
        <span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">updateDict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">fromHUC</span> <span class="p">:</span> <span class="n">subDict</span>
        <span class="p">}</span>
        
    <span class="n">saveJSON</span><span class="p">(</span><span class="n">updateDict</span><span class="p">,</span> <span class="n">outfl</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">updateDict</span></div>

<div class="viewcode-block" id="updateRaster"><a class="viewcode-back" href="../functions.html#tools.updateRaster">[docs]</a><span class="k">def</span> <span class="nf">updateRaster</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">grd</span><span class="p">,</span><span class="n">outgrd</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Insert value into grid at location specified by x,y; writes new raster to output grid.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x : list or float</span>
<span class="sd">        Horizontal coordinate in map units.</span>
<span class="sd">    y : list of float</span>
<span class="sd">        Vertical coordinate in map units.</span>
<span class="sd">    val : int or float</span>
<span class="sd">        Value to insert into raster at grd.</span>
<span class="sd">    grd : str</span>
<span class="sd">        Path to raster to be updated.</span>
<span class="sd">    outgrd : str (path)</span>
<span class="sd">        Path to write updated raster to.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dat : raster</span>
<span class="sd">        Raster dataset written to grdout.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">y</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    
    <span class="n">dat</span><span class="p">,</span><span class="n">meta</span> <span class="o">=</span> <span class="n">loadRaster</span><span class="p">(</span><span class="n">grd</span><span class="p">,</span> <span class="n">returnMeta</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="k">with</span> <span class="n">rs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">grd</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span> <span class="c1"># iterate over the supplied points </span>
        <span class="k">for</span> <span class="n">xx</span><span class="p">,</span><span class="n">yy</span><span class="p">,</span><span class="n">vv</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">val</span><span class="p">):</span>
            <span class="n">c</span><span class="p">,</span><span class="n">r</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">xx</span><span class="p">),</span><span class="nb">float</span><span class="p">(</span><span class="n">yy</span><span class="p">))</span> <span class="c1"># get column, row coordinates</span>
            <span class="n">dat</span><span class="p">[</span><span class="n">c</span><span class="p">,</span><span class="n">r</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">vv</span><span class="p">))</span> <span class="c1"># update the dataset</span>
            
    <span class="n">meta</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
        <span class="s1">&#39;compress&#39;</span><span class="p">:</span><span class="s1">&#39;LZW&#39;</span><span class="p">,</span>
        <span class="s1">&#39;profile&#39;</span><span class="p">:</span><span class="s1">&#39;GeoTIFF&#39;</span><span class="p">,</span>
        <span class="s1">&#39;tiled&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span>
        <span class="s1">&#39;sparse_ok&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span>
        <span class="s1">&#39;num_threads&#39;</span><span class="p">:</span><span class="s1">&#39;ALL_CPUS&#39;</span><span class="p">,</span>
        <span class="s1">&#39;bigtiff&#39;</span><span class="p">:</span><span class="s1">&#39;IF_SAFER&#39;</span><span class="p">,</span>
        <span class="s1">&#39;driver&#39;</span> <span class="p">:</span> <span class="s2">&quot;GTiff&quot;</span>
    <span class="p">})</span>
            
    <span class="k">with</span> <span class="n">rs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">outgrd</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">,</span><span class="o">**</span><span class="n">meta</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span> <span class="c1"># open dataset for output</span>
        <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="makeFACweight"><a class="viewcode-back" href="../functions.html#tools.makeFACweight">[docs]</a><span class="k">def</span> <span class="nf">makeFACweight</span><span class="p">(</span><span class="n">ingrd</span><span class="p">,</span><span class="n">outWeight</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Make FAC weighting grid of ones based on the extents of the input grid. No-data cells are persisted.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ingrd : str</span>
<span class="sd">        Path to input raster from which to generate the weighting grid from.</span>
<span class="sd">    outWeight : str</span>
<span class="sd">        Path to the output weighting raster generated.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    outWeight : raster</span>
<span class="sd">        Raster of the same extent and resolution as the input grid, but filled with ones where data exist. No-data cells are persisted.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">dat</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="n">loadRaster</span><span class="p">(</span><span class="n">ingrd</span><span class="p">,</span> <span class="n">returnMeta</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="n">ones</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span> <span class="c1"># make a grid of ones shaped like the original FAC grid. These will be used</span>
    <span class="c1"># as a weighting grid that can be corrected.</span>
    
    <span class="n">ones</span><span class="p">[</span><span class="n">dat</span> <span class="o">==</span> <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;nodata&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;nodata&#39;</span><span class="p">]</span> <span class="c1"># persist the noData value into the grid</span>
    <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;dtype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ones</span><span class="o">.</span><span class="n">dtype</span> <span class="c1"># update the datatype</span>
    <span class="n">meta</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
        <span class="s1">&#39;compress&#39;</span><span class="p">:</span><span class="s1">&#39;LZW&#39;</span><span class="p">,</span>
        <span class="s1">&#39;profile&#39;</span><span class="p">:</span><span class="s1">&#39;GeoTIFF&#39;</span><span class="p">,</span>
        <span class="s1">&#39;tiled&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span>
        <span class="s1">&#39;sparse_ok&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span>
        <span class="s1">&#39;num_threads&#39;</span><span class="p">:</span><span class="s1">&#39;ALL_CPUS&#39;</span><span class="p">,</span>
        <span class="s1">&#39;bigtiff&#39;</span><span class="p">:</span><span class="s1">&#39;IF_SAFER&#39;</span><span class="p">,</span>
        <span class="s1">&#39;driver&#39;</span> <span class="p">:</span> <span class="s2">&quot;GTiff&quot;</span>
    <span class="p">})</span>
    
    <span class="k">with</span> <span class="n">rs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">outWeight</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">,</span><span class="o">**</span><span class="n">meta</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
        <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ones</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="adjustFAC"><a class="viewcode-back" href="../functions.html#tools.adjustFAC">[docs]</a><span class="k">def</span> <span class="nf">adjustFAC</span><span class="p">(</span><span class="n">facWeighttemplate</span><span class="p">,</span> <span class="n">downstreamFACweightFl</span><span class="p">,</span> <span class="n">updateDictFl</span><span class="p">,</span> <span class="n">downstreamFDRFl</span><span class="p">,</span> <span class="n">adjFACFl</span><span class="p">,</span> <span class="n">cores</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">mpiCall</span> <span class="o">=</span> <span class="s1">&#39;mpiexec&#39;</span><span class="p">,</span> <span class="n">mpiArg</span> <span class="o">=</span> <span class="s1">&#39;-n&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Generate an updated flow accumulation grid (FAC) given an update dictionary produced by :py:func:`createUpdateDict`.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    facWeighttemplate : str</span>
<span class="sd">        Path to a FDR or FAC grid used to make the FAC weighting grid.</span>
<span class="sd">    downstreamFACweightFl : str</span>
<span class="sd">        Path to output the FAC weighting grid.</span>
<span class="sd">    updateDictFl : str</span>
<span class="sd">        Path to update dictionary used to update the FAC weighting grid.</span>
<span class="sd">    downstreamFDRFl : str</span>
<span class="sd">        Path to downstream FDR to use when computing the adjusted FAC grid.</span>
<span class="sd">    adjFACFl : str</span>
<span class="sd">        Path to output the adjusted FAC raster.</span>
<span class="sd">    cores : int (Optional)</span>
<span class="sd">        Number of cores to use. Defaults to 1.</span>
<span class="sd">    mpiCall : str (optional)</span>
<span class="sd">        MPI program to use to execute the program, defaults to mpiexec.</span>
<span class="sd">    mpiArg : str (optional)</span>
<span class="sd">        Argument to pass to mpiCall, defaults to -n.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    adjFACFl : raster</span>
<span class="sd">        Adjusted flow accumulation raster at adjFACFl</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">updateDict</span> <span class="o">=</span> <span class="n">loadJSON</span><span class="p">(</span><span class="n">updateDictFl</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">updateDict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span> <span class="c1"># for each upstream HUC.</span>

        <span class="n">upstreamDict</span> <span class="o">=</span> <span class="n">updateDict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="c1"># subset out the upstream HUC of interest</span>
        <span class="k">if</span> <span class="s1">&#39;maxUpstreamFAC&#39;</span> <span class="ow">in</span> <span class="n">upstreamDict</span><span class="p">[</span><span class="s1">&#39;vars&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">downstreamFACweightFl</span><span class="p">):</span> <span class="c1"># If weighting file not present, create one at the supplied path.</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Generating FAC weighting grid.&quot;</span><span class="p">)</span>
                <span class="n">makeFACweight</span><span class="p">(</span><span class="n">facWeighttemplate</span><span class="p">,</span><span class="n">downstreamFACweightFl</span><span class="p">)</span> 
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">downstreamFACweightFl</span><span class="p">):</span> <span class="c1"># if the weighting grid is present, update it with the upstream value.</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Updating FAC weighting grid with value from </span><span class="si">%s</span><span class="s2"> FAC&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
                <span class="n">updateRaster</span><span class="p">(</span><span class="n">upstreamDict</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span>
                             <span class="n">upstreamDict</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span>
                             <span class="n">upstreamDict</span><span class="p">[</span><span class="s1">&#39;maxUpstreamFAC&#39;</span><span class="p">],</span>
                             <span class="n">downstreamFACweightFl</span><span class="p">,</span><span class="n">downstreamFACweightFl</span><span class="p">)</span> <span class="c1"># update with lists</span>
            
    <span class="n">accumulateParam</span><span class="p">(</span><span class="n">downstreamFACweightFl</span><span class="p">,</span> <span class="n">downstreamFDRFl</span><span class="p">,</span> <span class="n">adjFACFl</span><span class="p">,</span> <span class="n">cores</span> <span class="o">=</span> <span class="n">cores</span><span class="p">)</span> <span class="c1"># run a parameter accumulation on the weighting grid.</span></div>

<div class="viewcode-block" id="updateDict"><a class="viewcode-back" href="../functions.html#tools.updateDict">[docs]</a><span class="k">def</span> <span class="nf">updateDict</span><span class="p">(</span><span class="n">ud</span><span class="p">,</span> <span class="n">upHUC</span><span class="p">,</span> <span class="n">varName</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Update dictionary created using :py:func:`createUpdateDict` with a parameter value.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ud : str</span>
<span class="sd">        Path to the update dictionary to add a parameter to.</span>
<span class="sd">    upHUC : str</span>
<span class="sd">        Name of the upstream HUC that the parameter corresponds to.</span>
<span class="sd">    varName : str</span>
<span class="sd">        Name to use for the parameter.</span>
<span class="sd">    val : list, int or float</span>
<span class="sd">        Value to add to the upstream dictonary.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ud : json</span>
<span class="sd">        Update dictionary written back out to ud.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    
    <span class="n">UD</span> <span class="o">=</span> <span class="n">loadJSON</span><span class="p">(</span><span class="n">ud</span><span class="p">)</span>
    
    <span class="n">upstream</span> <span class="o">=</span> <span class="n">UD</span><span class="p">[</span><span class="n">upHUC</span><span class="p">]</span>
    <span class="n">variables</span> <span class="o">=</span> <span class="n">upstream</span><span class="p">[</span><span class="s1">&#39;vars&#39;</span><span class="p">]</span>
    <span class="n">variables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">varName</span><span class="p">)</span>
    <span class="n">variables</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">variables</span><span class="p">))</span>
    <span class="n">upstream</span><span class="p">[</span><span class="s1">&#39;vars&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">variables</span>
    
    <span class="n">upstream</span><span class="p">[</span><span class="n">varName</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
    
    <span class="n">UD</span><span class="p">[</span><span class="n">upHUC</span><span class="p">]</span> <span class="o">=</span> <span class="n">upstream</span> <span class="c1"># update dictionary with upstream sub-dictionary</span>
    <span class="n">saveJSON</span><span class="p">(</span><span class="n">UD</span><span class="p">,</span> <span class="n">ud</span><span class="p">)</span> <span class="c1"># write out file</span></div>

<div class="viewcode-block" id="adjustParam"><a class="viewcode-back" href="../functions.html#tools.adjustParam">[docs]</a><span class="k">def</span> <span class="nf">adjustParam</span><span class="p">(</span><span class="n">updatedParam</span><span class="p">,</span> <span class="n">downstreamParamFL</span><span class="p">,</span> <span class="n">updateDictFl</span><span class="p">,</span> <span class="n">adjParamFl</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Generate an updated parameter grid given an update dictionary from :py:func:`createUpdateDict`.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    updatedParam : str</span>
<span class="sd">        Name of the parameter to update.</span>
<span class="sd">    downstreamParamFL : str</span>
<span class="sd">        Path to downstream parameter grid to update.</span>
<span class="sd">    updateDictFl : str</span>
<span class="sd">        Path to update dictionary to use.</span>
<span class="sd">    adjParamFl : str</span>
<span class="sd">        Path to output adjusted parameter file.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    adjParamFl : raster</span>
<span class="sd">        Adjusted parameter raster that can be accumulated prior to FCPG creation.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">updateDict</span> <span class="o">=</span> <span class="n">loadJSON</span><span class="p">(</span><span class="n">updateDictFl</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">updateDict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span> <span class="c1"># for each upstream HUC.</span>

        <span class="n">upstreamDict</span> <span class="o">=</span> <span class="n">updateDict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="c1"># subset out the upstream HUC of interest</span>
        <span class="k">if</span> <span class="n">updatedParam</span> <span class="ow">in</span> <span class="n">upstreamDict</span><span class="p">[</span><span class="s1">&#39;vars&#39;</span><span class="p">]:</span> 
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">downstreamParamFL</span><span class="p">):</span> <span class="c1"># if the weighting grid is present, update it with the upstream value.</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Updating parameter grid with value from </span><span class="si">%s</span><span class="s2"> FAC&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
                <span class="n">updateRaster</span><span class="p">(</span><span class="n">upstreamDict</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span>
                             <span class="n">upstreamDict</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span>
                             <span class="n">upstreamDict</span><span class="p">[</span><span class="n">updatedParam</span><span class="p">],</span>
                             <span class="n">downstreamParamFL</span><span class="p">,</span><span class="n">adjParamFl</span><span class="p">)</span> <span class="c1"># update with lists</span></div>

<div class="viewcode-block" id="d8todinfinity"><a class="viewcode-back" href="../functions.html#tools.d8todinfinity">[docs]</a><span class="k">def</span> <span class="nf">d8todinfinity</span><span class="p">(</span><span class="n">inRast</span><span class="p">,</span> <span class="n">outRast</span><span class="p">,</span> <span class="n">updateDict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;dtype&#39;</span><span class="p">:</span><span class="s1">&#39;float32&#39;</span><span class="p">,</span>
                <span class="s1">&#39;compress&#39;</span><span class="p">:</span><span class="s1">&#39;LZW&#39;</span><span class="p">,</span>
                <span class="s1">&#39;profile&#39;</span><span class="p">:</span><span class="s1">&#39;GeoTIFF&#39;</span><span class="p">,</span>
                <span class="s1">&#39;tiled&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;sparse_ok&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;num_threads&#39;</span><span class="p">:</span><span class="s1">&#39;ALL_CPUS&#39;</span><span class="p">,</span>
                <span class="s1">&#39;nodata&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                <span class="s1">&#39;bigtiff&#39;</span><span class="p">:</span><span class="s1">&#39;IF_SAFER&#39;</span><span class="p">}):</span>
    <span class="sd">&quot;&quot;&quot;Convert TauDEM D-8 flow directions to D-Infinity flow directions.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    inRast : str</span>
<span class="sd">        Path to a TauDEM D-8 flow direction raster.</span>
<span class="sd">    outRast : str</span>
<span class="sd">        Path to output the TauDEM D-Infinity flow direction raster.</span>
<span class="sd">    updateDict : dict (optional)</span>
<span class="sd">        Dictionary of Rasterio parameters used to write out the GeoTiff.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    outRast : str</span>
<span class="sd">        Path to output the TauDEM D-Infinity flow direction raster.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Reclassifying Flow Directions...&#39;</span><span class="p">)</span>

    <span class="c1"># load input data</span>
    <span class="k">with</span> <span class="n">rs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">inRast</span><span class="p">)</span> <span class="k">as</span> <span class="n">ds</span><span class="p">:</span>
        <span class="n">dat</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">inNoData</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">nodata</span>
        <span class="n">profile</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1"># save the metadata for output later</span>

    <span class="n">tauDir</span> <span class="o">=</span> <span class="n">dat</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">tauDir</span> <span class="o">=</span> <span class="n">tauDir</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span><span class="c1">#Store as 32bit float</span>
    <span class="n">tauDir</span><span class="p">[</span><span class="n">dat</span> <span class="o">==</span> <span class="n">inNoData</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="c1">#Set no data to nan</span>

    <span class="n">tauDir</span> <span class="o">=</span> <span class="p">(</span><span class="n">tauDir</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">4</span>

    <span class="n">tauDir</span><span class="p">[</span><span class="n">tauDir</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="c1"># no data</span>
    
    <span class="c1"># edit the metadata</span>
    <span class="n">profile</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">updateDict</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">rs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">outRast</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">,</span><span class="o">**</span><span class="n">profile</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
        <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">tauDir</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;TauDEM drainage direction written to: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">outRast</span><span class="p">))</span></div>

<div class="viewcode-block" id="changeNoData"><a class="viewcode-back" href="../functions.html#tools.changeNoData">[docs]</a><span class="k">def</span> <span class="nf">changeNoData</span><span class="p">(</span><span class="n">inRast</span><span class="p">,</span> <span class="n">newNoData</span><span class="p">,</span> <span class="n">updateDict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;compress&#39;</span><span class="p">:</span><span class="s1">&#39;LZW&#39;</span><span class="p">,</span>
                <span class="s1">&#39;profile&#39;</span><span class="p">:</span><span class="s1">&#39;GeoTIFF&#39;</span><span class="p">,</span>
                <span class="s1">&#39;tiled&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;sparse_ok&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;num_threads&#39;</span><span class="p">:</span><span class="s1">&#39;ALL_CPUS&#39;</span><span class="p">,</span>
                <span class="s1">&#39;bigtiff&#39;</span><span class="p">:</span><span class="s1">&#39;IF_SAFER&#39;</span><span class="p">}):</span>
    <span class="sd">&quot;&quot;&quot;Update raster no data value to a new value.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    inRast : str</span>
<span class="sd">        Path to input raster file.</span>
<span class="sd">    newNoData : str</span>
<span class="sd">        New no data value for the raster.</span>
<span class="sd">    updateDict : dict (optional)</span>
<span class="sd">        Dictionary of Rasterio parameters used to create the updated raster.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Opening raster...&#39;</span><span class="p">)</span>

    <span class="c1">#load input data</span>
    <span class="k">with</span> <span class="n">rs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">inRast</span><span class="p">)</span> <span class="k">as</span> <span class="n">ds</span><span class="p">:</span>
        <span class="n">dat</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">inNoData</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">nodata</span>
        <span class="n">profile</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1"># save the metadata for output later</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Changing no data values...&#39;</span><span class="p">)</span>
    <span class="n">dat</span><span class="p">[</span><span class="n">dat</span> <span class="o">==</span> <span class="n">inNoData</span><span class="p">]</span> <span class="o">=</span> <span class="n">newNoData</span> <span class="c1">#Change no data value</span>

    <span class="n">updateDict</span><span class="p">[</span><span class="s1">&#39;nodata&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">newNoData</span> <span class="c1"># add new noData value to the update dictionary.</span>

    <span class="c1"># edit the metadata</span>
    <span class="n">profile</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">updateDict</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">rs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">inRast</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">,</span><span class="o">**</span><span class="n">profile</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
        <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Raster written to: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">inRast</span><span class="p">))</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright Theodore Barnhart, Roy Sando, Seth Siefken, Peter McCarthy, and Al Rea

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>